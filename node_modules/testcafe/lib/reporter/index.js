'use strict';

exports.__esModule = true;

var _lodash = require('lodash');

var _pluginHost = require('./plugin-host');

var _pluginHost2 = _interopRequireDefault(_pluginHost);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Reporter {
    constructor(plugin, task, outStream) {
        this.plugin = new _pluginHost2.default(plugin, outStream);

        this.passed = 0;
        this.skipped = task.tests.filter(test => test.skip).length;
        this.testCount = task.tests.length - this.skipped;
        this.reportQueue = Reporter._createReportQueue(task);
        this.stopOnFirstFail = task.opts.stopOnFirstFail;

        this._assignTaskEventHandlers(task);
    }

    static _createReportQueue(task) {
        const runsPerTest = task.browserConnectionGroups.length;

        return task.tests.map(test => Reporter._createReportItem(test, runsPerTest));
    }

    static _createReportItem(test, runsPerTest) {
        return {
            fixture: test.fixture,
            test: test,
            screenshotPath: null,
            screenshots: [],
            quarantine: null,
            pendingRuns: runsPerTest,
            errs: [],
            unstable: false,
            startTime: null,
            testRunInfo: null
        };
    }

    static _createTestRunInfo(reportItem) {
        return {
            errs: (0, _lodash.sortBy)(reportItem.errs, ['userAgent', 'type']),
            durationMs: new Date() - reportItem.startTime,
            unstable: reportItem.unstable,
            screenshotPath: reportItem.screenshotPath,
            screenshots: reportItem.screenshots,
            quarantine: reportItem.quarantine,
            skipped: reportItem.test.skip
        };
    }

    _getReportItemForTestRun(testRun) {
        return (0, _lodash.find)(this.reportQueue, i => i.test === testRun.test);
    }

    _shiftReportQueue(reportItem) {
        let currentFixture = null;
        let nextReportItem = null;

        while (this.reportQueue.length && this.reportQueue[0].testRunInfo) {
            reportItem = this.reportQueue.shift();
            currentFixture = reportItem.fixture;

            this.plugin.reportTestDone(reportItem.test.name, reportItem.testRunInfo, reportItem.test.meta);

            // NOTE: here we assume that tests are sorted by fixture.
            // Therefore, if the next report item has a different
            // fixture, we can report this fixture start.
            nextReportItem = this.reportQueue[0];

            if (nextReportItem && nextReportItem.fixture !== currentFixture) this.plugin.reportFixtureStart(nextReportItem.fixture.name, nextReportItem.fixture.path, nextReportItem.fixture.meta);
        }
    }

    _assignTaskEventHandlers(task) {
        task.once('start', () => {
            const startTime = new Date();
            const userAgents = task.browserConnectionGroups.map(group => group[0].userAgent);
            const first = this.reportQueue[0];

            this.plugin.reportTaskStart(startTime, userAgents, this.testCount);
            this.plugin.reportFixtureStart(first.fixture.name, first.fixture.path, first.fixture.meta);
        });

        task.on('test-run-start', testRun => {
            const reportItem = this._getReportItemForTestRun(testRun);

            if (!reportItem.startTime) reportItem.startTime = new Date();
        });

        task.on('test-run-done', testRun => {
            const reportItem = this._getReportItemForTestRun(testRun);
            const isTestRunStoppedTaskExecution = !!testRun.errs.length && this.stopOnFirstFail;

            reportItem.pendingRuns = isTestRunStoppedTaskExecution ? 0 : reportItem.pendingRuns - 1;
            reportItem.unstable = reportItem.unstable || testRun.unstable;
            reportItem.errs = reportItem.errs.concat(testRun.errs);

            if (!reportItem.pendingRuns) {
                if (task.screenshots.hasCapturedFor(testRun.test)) {
                    reportItem.screenshotPath = task.screenshots.getPathFor(testRun.test);
                    reportItem.screenshots = task.screenshots.getScreenshotsInfo(testRun.test);
                }

                if (testRun.quarantine) {
                    reportItem.quarantine = testRun.quarantine.attempts.reduce((result, errors, index) => {
                        const passed = !errors.length;
                        const quarantineAttempt = index + 1;

                        result[quarantineAttempt] = { passed };

                        return result;
                    }, {});
                }

                if (!reportItem.testRunInfo) {
                    reportItem.testRunInfo = Reporter._createTestRunInfo(reportItem);

                    if (!reportItem.errs.length && !reportItem.test.skip) this.passed++;
                }

                this._shiftReportQueue(reportItem);
            }
        });

        task.once('done', () => {
            const endTime = new Date();

            this.plugin.reportTaskDone(endTime, this.passed, task.warningLog.messages);
        });
    }
}
exports.default = Reporter;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXBvcnRlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJSZXBvcnRlciIsImNvbnN0cnVjdG9yIiwicGx1Z2luIiwidGFzayIsIm91dFN0cmVhbSIsIlJlcG9ydGVyUGx1Z2luSG9zdCIsInBhc3NlZCIsInNraXBwZWQiLCJ0ZXN0cyIsImZpbHRlciIsInRlc3QiLCJza2lwIiwibGVuZ3RoIiwidGVzdENvdW50IiwicmVwb3J0UXVldWUiLCJfY3JlYXRlUmVwb3J0UXVldWUiLCJzdG9wT25GaXJzdEZhaWwiLCJvcHRzIiwiX2Fzc2lnblRhc2tFdmVudEhhbmRsZXJzIiwicnVuc1BlclRlc3QiLCJicm93c2VyQ29ubmVjdGlvbkdyb3VwcyIsIm1hcCIsIl9jcmVhdGVSZXBvcnRJdGVtIiwiZml4dHVyZSIsInNjcmVlbnNob3RQYXRoIiwic2NyZWVuc2hvdHMiLCJxdWFyYW50aW5lIiwicGVuZGluZ1J1bnMiLCJlcnJzIiwidW5zdGFibGUiLCJzdGFydFRpbWUiLCJ0ZXN0UnVuSW5mbyIsIl9jcmVhdGVUZXN0UnVuSW5mbyIsInJlcG9ydEl0ZW0iLCJkdXJhdGlvbk1zIiwiRGF0ZSIsIl9nZXRSZXBvcnRJdGVtRm9yVGVzdFJ1biIsInRlc3RSdW4iLCJpIiwiX3NoaWZ0UmVwb3J0UXVldWUiLCJjdXJyZW50Rml4dHVyZSIsIm5leHRSZXBvcnRJdGVtIiwic2hpZnQiLCJyZXBvcnRUZXN0RG9uZSIsIm5hbWUiLCJtZXRhIiwicmVwb3J0Rml4dHVyZVN0YXJ0IiwicGF0aCIsIm9uY2UiLCJ1c2VyQWdlbnRzIiwiZ3JvdXAiLCJ1c2VyQWdlbnQiLCJmaXJzdCIsInJlcG9ydFRhc2tTdGFydCIsIm9uIiwiaXNUZXN0UnVuU3RvcHBlZFRhc2tFeGVjdXRpb24iLCJjb25jYXQiLCJoYXNDYXB0dXJlZEZvciIsImdldFBhdGhGb3IiLCJnZXRTY3JlZW5zaG90c0luZm8iLCJhdHRlbXB0cyIsInJlZHVjZSIsInJlc3VsdCIsImVycm9ycyIsImluZGV4IiwicXVhcmFudGluZUF0dGVtcHQiLCJlbmRUaW1lIiwicmVwb3J0VGFza0RvbmUiLCJ3YXJuaW5nTG9nIiwibWVzc2FnZXMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQTs7QUFDQTs7Ozs7O0FBRWUsTUFBTUEsUUFBTixDQUFlO0FBQzFCQyxnQkFBYUMsTUFBYixFQUFxQkMsSUFBckIsRUFBMkJDLFNBQTNCLEVBQXNDO0FBQ2xDLGFBQUtGLE1BQUwsR0FBYyxJQUFJRyxvQkFBSixDQUF1QkgsTUFBdkIsRUFBK0JFLFNBQS9CLENBQWQ7O0FBRUEsYUFBS0UsTUFBTCxHQUF1QixDQUF2QjtBQUNBLGFBQUtDLE9BQUwsR0FBdUJKLEtBQUtLLEtBQUwsQ0FBV0MsTUFBWCxDQUFrQkMsUUFBUUEsS0FBS0MsSUFBL0IsRUFBcUNDLE1BQTVEO0FBQ0EsYUFBS0MsU0FBTCxHQUF1QlYsS0FBS0ssS0FBTCxDQUFXSSxNQUFYLEdBQW9CLEtBQUtMLE9BQWhEO0FBQ0EsYUFBS08sV0FBTCxHQUF1QmQsU0FBU2Usa0JBQVQsQ0FBNEJaLElBQTVCLENBQXZCO0FBQ0EsYUFBS2EsZUFBTCxHQUF1QmIsS0FBS2MsSUFBTCxDQUFVRCxlQUFqQzs7QUFFQSxhQUFLRSx3QkFBTCxDQUE4QmYsSUFBOUI7QUFDSDs7QUFFRCxXQUFPWSxrQkFBUCxDQUEyQlosSUFBM0IsRUFBaUM7QUFDN0IsY0FBTWdCLGNBQWNoQixLQUFLaUIsdUJBQUwsQ0FBNkJSLE1BQWpEOztBQUVBLGVBQU9ULEtBQUtLLEtBQUwsQ0FBV2EsR0FBWCxDQUFlWCxRQUFRVixTQUFTc0IsaUJBQVQsQ0FBMkJaLElBQTNCLEVBQWlDUyxXQUFqQyxDQUF2QixDQUFQO0FBQ0g7O0FBRUQsV0FBT0csaUJBQVAsQ0FBMEJaLElBQTFCLEVBQWdDUyxXQUFoQyxFQUE2QztBQUN6QyxlQUFPO0FBQ0hJLHFCQUFnQmIsS0FBS2EsT0FEbEI7QUFFSGIsa0JBQWdCQSxJQUZiO0FBR0hjLDRCQUFnQixJQUhiO0FBSUhDLHlCQUFnQixFQUpiO0FBS0hDLHdCQUFnQixJQUxiO0FBTUhD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QUFFRCxvQkFBSSxDQUFDN0IsV0FBV0YsV0FBaEIsRUFBNkI7QUFDekJFLCtCQUFXRixXQUFYLEdBQXlCL0IsU0FBU2dDLGtCQUFULENBQTRCQyxVQUE1QixDQUF6Qjs7QUFFQSx3QkFBSSxDQUFDQSxXQUFXTCxJQUFYLENBQWdCaEIsTUFBakIsSUFBMkIsQ0FBQ3FCLFdBQVd2QixJQUFYLENBQWdCQyxJQUFoRCxFQUNJLEtBQUtMLE1BQUw7QUFDUDs7QUFFRCxxQkFBS2lDLGlCQUFMLENBQXVCTixVQUF2QjtBQUNIO0FBQ0osU0FsQ0Q7O0FBb0NBOUIsYUFBSzZDLElBQUwsQ0FBVSxNQUFWLEVBQWtCLE1BQU07QUFDcEIsa0JBQU1rQixVQUFVLElBQUkvQixJQUFKLEVBQWhCOztBQUVBLGlCQUFLakMsTUFBTCxDQUFZaUUsY0FBWixDQUEyQkQsT0FBM0IsRUFBb0MsS0FBSzVELE1BQXpDLEVBQWlESCxLQUFLaUUsVUFBTCxDQUFnQkMsUUFBakU7QUFDSCxTQUpEO0FBS0g7QUFoSXlCO2tCQUFUckUsUSIsImZpbGUiOiJyZXBvcnRlci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZpbmQsIHNvcnRCeSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgUmVwb3J0ZXJQbHVnaW5Ib3N0IGZyb20gJy4vcGx1Z2luLWhvc3QnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZXBvcnRlciB7XG4gICAgY29uc3RydWN0b3IgKHBsdWdpbiwgdGFzaywgb3V0U3RyZWFtKSB7XG4gICAgICAgIHRoaXMucGx1Z2luID0gbmV3IFJlcG9ydGVyUGx1Z2luSG9zdChwbHVnaW4sIG91dFN0cmVhbSk7XG5cbiAgICAgICAgdGhpcy5wYXNzZWQgICAgICAgICAgPSAwO1xuICAgICAgICB0aGlzLnNraXBwZWQgICAgICAgICA9IHRhc2sudGVzdHMuZmlsdGVyKHRlc3QgPT4gdGVzdC5za2lwKS5sZW5ndGg7XG4gICAgICAgIHRoaXMudGVzdENvdW50ICAgICAgID0gdGFzay50ZXN0cy5sZW5ndGggLSB0aGlzLnNraXBwZWQ7XG4gICAgICAgIHRoaXMucmVwb3J0UXVldWUgICAgID0gUmVwb3J0ZXIuX2NyZWF0ZVJlcG9ydFF1ZXVlKHRhc2spO1xuICAgICAgICB0aGlzLnN0b3BPbkZpcnN0RmFpbCA9IHRhc2sub3B0cy5zdG9wT25GaXJzdEZhaWw7XG5cbiAgICAgICAgdGhpcy5fYXNzaWduVGFza0V2ZW50SGFuZGxlcnModGFzayk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9jcmVhdGVSZXBvcnRRdWV1ZSAodGFzaykge1xuICAgICAgICBjb25zdCBydW5zUGVyVGVzdCA9IHRhc2suYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMubGVuZ3RoO1xuXG4gICAgICAgIHJldHVybiB0YXNrLnRlc3RzLm1hcCh0ZXN0ID0+IFJlcG9ydGVyLl9jcmVhdGVSZXBvcnRJdGVtKHRlc3QsIHJ1bnNQZXJUZXN0KSk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9jcmVhdGVSZXBvcnRJdGVtICh0ZXN0LCBydW5zUGVyVGVzdCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZml4dHVyZTogICAgICAgIHRlc3QuZml4dHVyZSxcbiAgICAgICAgICAgIHRlc3Q6ICAgICAgICAgICB0ZXN0LFxuICAgICAgICAgICAgc2NyZWVuc2hvdFBhdGg6IG51bGwsXG4gICAgICAgICAgICBzY3JlZW5zaG90czogICAgW10sXG4gICAgICAgICAgICBxdWFyYW50aW5lOiAgICAgbnVsbCxcbiAgICAgICAgICAgIHBlbmRpbmdSdW5zOiAgICBydW5zUGVyVGVzdCxcbiAgICAgICAgICAgIGVycnM6ICAgICAgICAgICBbXSxcbiAgICAgICAgICAgIHVuc3RhYmxlOiAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIHN0YXJ0VGltZTogICAgICBudWxsLFxuICAgICAgICAgICAgdGVzdFJ1bkluZm86ICAgIG51bGxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2NyZWF0ZVRlc3RSdW5JbmZvIChyZXBvcnRJdGVtKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlcnJzOiAgICAgICAgICAgc29ydEJ5KHJlcG9ydEl0ZW0uZXJycywgWyd1c2VyQWdlbnQnLCAndHlwZSddKSxcbiAgICAgICAgICAgIGR1cmF0aW9uTXM6ICAgICBuZXcgRGF0ZSgpIC0gcmVwb3J0SXRlbS5zdGFydFRpbWUsXG4gICAgICAgICAgICB1bnN0YWJsZTogICAgICAgcmVwb3J0SXRlbS51bnN0YWJsZSxcbiAgICAgICAgICAgIHNjcmVlbnNob3RQYXRoOiByZXBvcnRJdGVtLnNjcmVlbnNob3RQYXRoLFxuICAgICAgICAgICAgc2NyZWVuc2hvdHM6ICAgIHJlcG9ydEl0ZW0uc2NyZWVuc2hvdHMsXG4gICAgICAgICAgICBxdWFyYW50aW5lOiAgICAgcmVwb3J0SXRlbS5xdWFyYW50aW5lLFxuICAgICAgICAgICAgc2tpcHBlZDogICAgICAgIHJlcG9ydEl0ZW0udGVzdC5za2lwXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2dldFJlcG9ydEl0ZW1Gb3JUZXN0UnVuICh0ZXN0UnVuKSB7XG4gICAgICAgIHJldHVybiBmaW5kKHRoaXMucmVwb3J0UXVldWUsIGkgPT4gaS50ZXN0ID09PSB0ZXN0UnVuLnRlc3QpO1xuICAgIH1cblxuICAgIF9zaGlmdFJlcG9ydFF1ZXVlIChyZXBvcnRJdGVtKSB7XG4gICAgICAgIGxldCBjdXJyZW50Rml4dHVyZSA9IG51bGw7XG4gICAgICAgIGxldCBuZXh0UmVwb3J0SXRlbSA9IG51bGw7XG5cbiAgICAgICAgd2hpbGUgKHRoaXMucmVwb3J0UXVldWUubGVuZ3RoICYmIHRoaXMucmVwb3J0UXVldWVbMF0udGVzdFJ1bkluZm8pIHtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0gICAgID0gdGhpcy5yZXBvcnRRdWV1ZS5zaGlmdCgpO1xuICAgICAgICAgICAgY3VycmVudEZpeHR1cmUgPSByZXBvcnRJdGVtLmZpeHR1cmU7XG5cbiAgICAgICAgICAgIHRoaXMucGx1Z2luLnJlcG9ydFRlc3REb25lKHJlcG9ydEl0ZW0udGVzdC5uYW1lLCByZXBvcnRJdGVtLnRlc3RSdW5JbmZvLCByZXBvcnRJdGVtLnRlc3QubWV0YSk7XG5cbiAgICAgICAgICAgIC8vIE5PVEU6IGhlcmUgd2UgYXNzdW1lIHRoYXQgdGVzdHMgYXJlIHNvcnRlZCBieSBmaXh0dXJlLlxuICAgICAgICAgICAgLy8gVGhlcmVmb3JlLCBpZiB0aGUgbmV4dCByZXBvcnQgaXRlbSBoYXMgYSBkaWZmZXJlbnRcbiAgICAgICAgICAgIC8vIGZpeHR1cmUsIHdlIGNhbiByZXBvcnQgdGhpcyBmaXh0dXJlIHN0YXJ0LlxuICAgICAgICAgICAgbmV4dFJlcG9ydEl0ZW0gPSB0aGlzLnJlcG9ydFF1ZXVlWzBdO1xuXG4gICAgICAgICAgICBpZiAobmV4dFJlcG9ydEl0ZW0gJiYgbmV4dFJlcG9ydEl0ZW0uZml4dHVyZSAhPT0gY3VycmVudEZpeHR1cmUpXG4gICAgICAgICAgICAgICAgdGhpcy5wbHVnaW4ucmVwb3J0Rml4dHVyZVN0YXJ0KG5leHRSZXBvcnRJdGVtLmZpeHR1cmUubmFtZSwgbmV4dFJlcG9ydEl0ZW0uZml4dHVyZS5wYXRoLCBuZXh0UmVwb3J0SXRlbS5maXh0dXJlLm1ldGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2Fzc2lnblRhc2tFdmVudEhhbmRsZXJzICh0YXNrKSB7XG4gICAgICAgIHRhc2sub25jZSgnc3RhcnQnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBzdGFydFRpbWUgID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJBZ2VudHMgPSB0YXNrLmJyb3dzZXJDb25uZWN0aW9uR3JvdXBzLm1hcChncm91cCA9PiBncm91cFswXS51c2VyQWdlbnQpO1xuICAgICAgICAgICAgY29uc3QgZmlyc3QgICAgICA9IHRoaXMucmVwb3J0UXVldWVbMF07XG5cbiAgICAgICAgICAgIHRoaXMucGx1Z2luLnJlcG9ydFRhc2tTdGFydChzdGFydFRpbWUsIHVzZXJBZ2VudHMsIHRoaXMudGVzdENvdW50KTtcbiAgICAgICAgICAgIHRoaXMucGx1Z2luLnJlcG9ydEZpeHR1cmVTdGFydChmaXJzdC5maXh0dXJlLm5hbWUsIGZpcnN0LmZpeHR1cmUucGF0aCwgZmlyc3QuZml4dHVyZS5tZXRhKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGFzay5vbigndGVzdC1ydW4tc3RhcnQnLCB0ZXN0UnVuID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcG9ydEl0ZW0gPSB0aGlzLl9nZXRSZXBvcnRJdGVtRm9yVGVzdFJ1bih0ZXN0UnVuKTtcblxuICAgICAgICAgICAgaWYgKCFyZXBvcnRJdGVtLnN0YXJ0VGltZSlcbiAgICAgICAgICAgICAgICByZXBvcnRJdGVtLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRhc2sub24oJ3Rlc3QtcnVuLWRvbmUnLCB0ZXN0UnVuID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcG9ydEl0ZW0gICAgICAgICAgICAgICAgICAgID0gdGhpcy5fZ2V0UmVwb3J0SXRlbUZvclRlc3RSdW4odGVzdFJ1bik7XG4gICAgICAgICAgICBjb25zdCBpc1Rlc3RSdW5TdG9wcGVkVGFza0V4ZWN1dGlvbiA9ICEhdGVzdFJ1bi5lcnJzLmxlbmd0aCAmJiB0aGlzLnN0b3BPbkZpcnN0RmFpbDtcblxuICAgICAgICAgICAgcmVwb3J0SXRlbS5wZW5kaW5nUnVucyA9IGlzVGVzdFJ1blN0b3BwZWRUYXNrRXhlY3V0aW9uID8gMCA6IHJlcG9ydEl0ZW0ucGVuZGluZ1J1bnMgLSAxO1xuICAgICAgICAgICAgcmVwb3J0SXRlbS51bnN0YWJsZSAgICA9IHJlcG9ydEl0ZW0udW5zdGFibGUgfHwgdGVzdFJ1bi51bnN0YWJsZTtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0uZXJycyAgICAgICAgPSByZXBvcnRJdGVtLmVycnMuY29uY2F0KHRlc3RSdW4uZXJycyk7XG5cbiAgICAgICAgICAgIGlmICghcmVwb3J0SXRlbS5wZW5kaW5nUnVucykge1xuICAgICAgICAgICAgICAgIGlmICh0YXNrLnNjcmVlbnNob3RzLmhhc0NhcHR1cmVkRm9yKHRlc3RSdW4udGVzdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVwb3J0SXRlbS5zY3JlZW5zaG90UGF0aCA9IHRhc2suc2NyZWVuc2hvdHMuZ2V0UGF0aEZvcih0ZXN0UnVuLnRlc3QpO1xuICAgICAgICAgICAgICAgICAgICByZXBvcnRJdGVtLnNjcmVlbnNob3RzICAgID0gdGFzay5zY3JlZW5zaG90cy5nZXRTY3JlZW5zaG90c0luZm8odGVzdFJ1bi50ZXN0KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodGVzdFJ1bi5xdWFyYW50aW5lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcG9ydEl0ZW0ucXVhcmFudGluZSA9IHRlc3RSdW4ucXVhcmFudGluZS5hdHRlbXB0cy5yZWR1Y2UoKHJlc3VsdCwgZXJyb3JzLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFzc2VkICAgICAgICAgICAgICA9ICFlcnJvcnMubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcXVhcmFudGluZUF0dGVtcHQgPSBpbmRleCArIDE7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtxdWFyYW50aW5lQXR0ZW1wdF0gPSB7IHBhc3NlZCB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICAgICAgICB9LCB7fSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCFyZXBvcnRJdGVtLnRlc3RSdW5JbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcG9ydEl0ZW0udGVzdFJ1bkluZm8gPSBSZXBvcnRlci5fY3JlYXRlVGVzdFJ1bkluZm8ocmVwb3J0SXRlbSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXBvcnRJdGVtLmVycnMubGVuZ3RoICYmICFyZXBvcnRJdGVtLnRlc3Quc2tpcClcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFzc2VkKys7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhpcy5fc2hpZnRSZXBvcnRRdWV1ZShyZXBvcnRJdGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGFzay5vbmNlKCdkb25lJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZW5kVGltZSA9IG5ldyBEYXRlKCk7XG5cbiAgICAgICAgICAgIHRoaXMucGx1Z2luLnJlcG9ydFRhc2tEb25lKGVuZFRpbWUsIHRoaXMucGFzc2VkLCB0YXNrLndhcm5pbmdMb2cubWVzc2FnZXMpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=
