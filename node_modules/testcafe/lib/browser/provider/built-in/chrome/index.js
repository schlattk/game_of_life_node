'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _osFamily = require('os-family');

var _osFamily2 = _interopRequireDefault(_osFamily);

var _url = require('url');

var _runtimeInfo = require('./runtime-info');

var _runtimeInfo2 = _interopRequireDefault(_runtimeInfo);

var _config = require('./config');

var _config2 = _interopRequireDefault(_config);

var _localChrome = require('./local-chrome');

var _cdp = require('./cdp');

var cdp = _interopRequireWildcard(_cdp);

var _getMaximizedHeadlessWindowSize = require('../../utils/get-maximized-headless-window-size');

var _getMaximizedHeadlessWindowSize2 = _interopRequireDefault(_getMaximizedHeadlessWindowSize);

var _clientFunctions = require('../../utils/client-functions');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = {
    openedBrowsers: {},

    isMultiBrowser: false,

    openBrowser(browserId, pageUrl, configString) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = yield (0, _runtimeInfo2.default)((0, _url.parse)(pageUrl).hostname, configString);
            const browserName = _this.providerName.replace(':', '');

            runtimeInfo.browserId = browserId;
            runtimeInfo.browserName = browserName;

            runtimeInfo.providerMethods = {
                resizeLocalBrowserWindow: function resizeLocalBrowserWindow(...args) {
                    return _this.resizeLocalBrowserWindow(...args);
                }
            };

            yield (0, _localChrome.start)(pageUrl, runtimeInfo);

            yield _this.waitForConnectionReady(browserId);

            runtimeInfo.viewportSize = yield _this.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

            yield cdp.createClient(runtimeInfo);

            _this.openedBrowsers[browserId] = runtimeInfo;
        })();
    },

    closeBrowser(browserId) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = _this2.openedBrowsers[browserId];

            if (cdp.isHeadlessTab(runtimeInfo)) yield cdp.closeTab(runtimeInfo);else yield _this2.closeLocalBrowser(browserId);

            if (_osFamily2.default.mac || runtimeInfo.config.headless) yield (0, _localChrome.stop)(runtimeInfo);

            if (runtimeInfo.tempProfileDir) yield runtimeInfo.tempProfileDir.dispose();

            delete _this2.openedBrowsers[browserId];
        })();
    },

    isLocalBrowser(browserId, configString) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const config = _this3.openedBrowsers[browserId] ? _this3.openedBrowsers[browserId].config : (0, _config2.default)(configString);

            return !config.headless;
        })();
    },

    isHeadlessBrowser(browserId) {
        const config = this.openedBrowsers[browserId].config;

        return config && config.headless;
    },

    takeScreenshot(browserId, path) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = _this4.openedBrowsers[browserId];

            yield cdp.takeScreenshot(path, runtimeInfo);
        })();
    },

    resizeWindow(browserId, width, height, currentWidth, currentHeight) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = _this5.openedBrowsers[browserId];

            if (runtimeInfo.config.mobile) yield cdp.updateMobileViewportSize(runtimeInfo);else {
                runtimeInfo.viewportSize.width = currentWidth;
                runtimeInfo.viewportSize.height = currentHeight;
            }

            yield cdp.resizeWindow({ width, height }, runtimeInfo);
        })();
    },

    maximizeWindow(browserId) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const maximumSize = (0, _getMaximizedHeadlessWindowSize2.default)();

            yield _this6.resizeWindow(browserId, maximumSize.width, maximumSize.height, maximumSize.width, maximumSize.height);
        })();
    },

    hasCustomActionForBrowser(browserId) {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var _openedBrowsers$brows = _this7.openedBrowsers[browserId];
            const config = _openedBrowsers$brows.config,
                  client = _openedBrowsers$brows.client;


            return {
                hasCloseBrowser: true,
                hasResizeWindow: !!client && (config.emulation || config.headless),
                hasMaximizeWindow: !!client && config.headless,
                hasTakeScreenshot: !!client,
                hasChromelessScreenshots: !!client,
                hasCanResizeWindowToDimensions: false
            };
        })();
    }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2Nocm9tZS9pbmRleC5qcyJdLCJuYW1lcyI6WyJjZHAiLCJvcGVuZWRCcm93c2VycyIsImlzTXVsdGlCcm93c2VyIiwib3BlbkJyb3dzZXIiLCJicm93c2VySWQiLCJwYWdlVXJsIiwiY29uZmlnU3RyaW5nIiwicnVudGltZUluZm8iLCJob3N0bmFtZSIsImJyb3dzZXJOYW1lIiwicHJvdmlkZXJOYW1lIiwicmVwbGFjZSIsInByb3ZpZGVyTWV0aG9kcyIsInJlc2l6ZUxvY2FsQnJvd3NlcldpbmRvdyIsImFyZ3MiLCJ3YWl0Rm9yQ29ubmVjdGlvblJlYWR5Iiwidmlld3BvcnRTaXplIiwicnVuSW5pdFNjcmlwdCIsIkdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCIsImNyZWF0ZUNsaWVudCIsImNsb3NlQnJvd3NlciIsImlzSGVhZGxlc3NUYWIiLCJjbG9zZVRhYiIsImNsb3NlTG9jYWxCcm93c2VyIiwiT1MiLCJtYWMiLCJjb25maWciLCJoZWFkbGVzcyIsInRlbXBQcm9maWxlRGlyIiwiZGlzcG9zZSIsImlzTG9jYWxCcm93c2VyIiwiaXNIZWFkbGVzc0Jyb3dzZXIiLCJ0YWtlU2NyZWVuc2hvdCIsInBhdGgiLCJyZXNpemVXaW5kb3ciLCJ3aWR0aCIsImhlaWdodCIsImN1cnJlbnRXaWR0aCIsImN1cnJlbnRIZWlnaHQiLCJtb2JpbGUiLCJ1cGRhdGVNb2JpbGVWaWV3cG9ydFNpemUiLCJtYXhpbWl6ZVdpbmRvdyIsIm1heGltdW1TaXplIiwiaGFzQ3VzdG9tQWN0aW9uRm9yQnJvd3NlciIsImNsaWVudCIsImhhc0Nsb3NlQnJvd3NlciIsImhhc1Jlc2l6ZVdpbmRvdyIsImVtdWxhdGlvbiIsImhhc01heGltaXplV2luZG93IiwiaGFzVGFrZVNjcmVlbnNob3QiLCJoYXNDaHJvbWVsZXNzU2NyZWVuc2hvdHMiLCJoYXNDYW5SZXNpemVXaW5kb3dUb0RpbWVu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LElBQVlsQixPQUFPQyxRQUhoRDtBQUlIc0IsbUNBQWdDLENBQUMsQ0FBQ0wsTUFKL0I7QUFLSE0sMENBQWdDLENBQUMsQ0FBQ04sTUFML0I7QUFNSE8sZ0RBQWdDO0FBTjdCLGFBQVA7QUFId0M7QUFXM0M7QUE1RlUsQyIsImZpbGUiOiJicm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2Nocm9tZS9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPUyBmcm9tICdvcy1mYW1pbHknO1xuaW1wb3J0IHsgcGFyc2UgYXMgcGFyc2VVcmwgfSBmcm9tICd1cmwnO1xuaW1wb3J0IGdldFJ1bnRpbWVJbmZvIGZyb20gJy4vcnVudGltZS1pbmZvJztcbmltcG9ydCBnZXRDb25maWcgZnJvbSAnLi9jb25maWcnO1xuaW1wb3J0IHsgc3RhcnQgYXMgc3RhcnRMb2NhbENocm9tZSwgc3RvcCBhcyBzdG9wTG9jYWxDaHJvbWUgfSBmcm9tICcuL2xvY2FsLWNocm9tZSc7XG5pbXBvcnQgKiBhcyBjZHAgZnJvbSAnLi9jZHAnO1xuaW1wb3J0IGdldE1heGltaXplZEhlYWRsZXNzV2luZG93U2l6ZSBmcm9tICcuLi8uLi91dGlscy9nZXQtbWF4aW1pemVkLWhlYWRsZXNzLXdpbmRvdy1zaXplJztcbmltcG9ydCB7IEdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCB9IGZyb20gJy4uLy4uL3V0aWxzL2NsaWVudC1mdW5jdGlvbnMnO1xuXG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgICBvcGVuZWRCcm93c2Vyczoge30sXG5cbiAgICBpc011bHRpQnJvd3NlcjogZmFsc2UsXG5cbiAgICBhc3luYyBvcGVuQnJvd3NlciAoYnJvd3NlcklkLCBwYWdlVXJsLCBjb25maWdTdHJpbmcpIHtcbiAgICAgICAgY29uc3QgcnVudGltZUluZm8gPSBhd2FpdCBnZXRSdW50aW1lSW5mbyhwYXJzZVVybChwYWdlVXJsKS5ob3N0bmFtZSwgY29uZmlnU3RyaW5nKTtcbiAgICAgICAgY29uc3QgYnJvd3Nlck5hbWUgPSB0aGlzLnByb3ZpZGVyTmFtZS5yZXBsYWNlKCc6JywgJycpO1xuXG4gICAgICAgIHJ1bnRpbWVJbmZvLmJyb3dzZXJJZCAgID0gYnJvd3NlcklkO1xuICAgICAgICBydW50aW1lSW5mby5icm93c2VyTmFtZSA9IGJyb3dzZXJOYW1lO1xuXG4gICAgICAgIHJ1bnRpbWVJbmZvLnByb3ZpZGVyTWV0aG9kcyA9IHtcbiAgICAgICAgICAgIHJlc2l6ZUxvY2FsQnJvd3NlcldpbmRvdzogKC4uLmFyZ3MpID0+IHRoaXMucmVzaXplTG9jYWxCcm93c2VyV2luZG93KC4uLmFyZ3MpXG4gICAgICAgIH07XG5cbiAgICAgICAgYXdhaXQgc3RhcnRMb2NhbENocm9tZShwYWdlVXJsLCBydW50aW1lSW5mbyk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yQ29ubmVjdGlvblJlYWR5KGJyb3dzZXJJZCk7XG5cbiAgICAgICAgcnVudGltZUluZm8udmlld3BvcnRTaXplID0gYXdhaXQgdGhpcy5ydW5Jbml0U2NyaXB0KGJyb3dzZXJJZCwgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUKTtcblxuICAgICAgICBhd2FpdCBjZHAuY3JlYXRlQ2xpZW50KHJ1bnRpbWVJbmZvKTtcblxuICAgICAgICB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF0gPSBydW50aW1lSW5mbztcbiAgICB9LFxuXG4gICAgYXN5bmMgY2xvc2VCcm93c2VyIChicm93c2VySWQpIHtcbiAgICAgICAgY29uc3QgcnVudGltZUluZm8gPSB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF07XG5cbiAgICAgICAgaWYgKGNkcC5pc0hlYWRsZXNzVGFiKHJ1bnRpbWVJbmZvKSlcbiAgICAgICAgICAgIGF3YWl0IGNkcC5jbG9zZVRhYihydW50aW1lSW5mbyk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2xvc2VMb2NhbEJyb3dzZXIoYnJvd3NlcklkKTtcblxuICAgICAgICBpZiAoT1MubWFjIHx8IHJ1bnRpbWVJbmZvLmNvbmZpZy5oZWFkbGVzcylcbiAgICAgICAgICAgIGF3YWl0IHN0b3BMb2NhbENocm9tZShydW50aW1lSW5mbyk7XG5cbiAgICAgICAgaWYgKHJ1bnRpbWVJbmZvLnRlbXBQcm9maWxlRGlyKVxuICAgICAgICAgICAgYXdhaXQgcnVudGltZUluZm8udGVtcFByb2ZpbGVEaXIuZGlzcG9zZSgpO1xuXG4gICAgICAgIGRlbGV0ZSB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF07XG4gICAgfSxcblxuICAgIGFzeW5jIGlzTG9jYWxCcm93c2VyIChicm93c2VySWQsIGNvbmZpZ1N0cmluZykge1xuICAgICAgICBjb25zdCBjb25maWcgPSB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF0gPyB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF0uY29uZmlnIDogZ2V0Q29uZmlnKGNvbmZpZ1N0cmluZyk7XG5cbiAgICAgICAgcmV0dXJuICFjb25maWcuaGVhZGxlc3M7XG4gICAgfSxcblxuICAgIGlzSGVhZGxlc3NCcm93c2VyIChicm93c2VySWQpIHtcbiAgICAgICAgY29uc3QgY29uZmlnID0gdGhpcy5vcGVuZWRCcm93c2Vyc1ticm93c2VySWRdLmNvbmZpZztcblxuICAgICAgICByZXR1cm4gY29uZmlnICYmIGNvbmZpZy5oZWFkbGVzcztcbiAgICB9LFxuXG4gICAgYXN5bmMgdGFrZVNjcmVlbnNob3QgKGJyb3dzZXJJZCwgcGF0aCkge1xuICAgICAgICBjb25zdCBydW50aW1lSW5mbyA9IHRoaXMub3BlbmVkQnJvd3NlcnNbYnJvd3NlcklkXTtcblxuICAgICAgICBhd2FpdCBjZHAudGFrZVNjcmVlbnNob3QocGF0aCwgcnVudGltZUluZm8pO1xuICAgIH0sXG5cbiAgICBhc3luYyByZXNpemVXaW5kb3cgKGJyb3dzZXJJZCwgd2lkdGgsIGhlaWdodCwgY3VycmVudFdpZHRoLCBjdXJyZW50SGVpZ2h0KSB7XG4gICAgICAgIGNvbnN0IHJ1bnRpbWVJbmZvID0gdGhpcy5vcGVuZWRCcm93c2Vyc1ticm93c2VySWRdO1xuXG4gICAgICAgIGlmIChydW50aW1lSW5mby5jb25maWcubW9iaWxlKVxuICAgICAgICAgICAgYXdhaXQgY2RwLnVwZGF0ZU1vYmlsZVZpZXdwb3J0U2l6ZShydW50aW1lSW5mbyk7XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcnVudGltZUluZm8udmlld3BvcnRTaXplLndpZHRoICA9IGN1cnJlbnRXaWR0aDtcbiAgICAgICAgICAgIHJ1bnRpbWVJbmZvLnZpZXdwb3J0U2l6ZS5oZWlnaHQgPSBjdXJyZW50SGVpZ2h0O1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgY2RwLnJlc2l6ZVdpbmRvdyh7IHdpZHRoLCBoZWlnaHQgfSwgcnVudGltZUluZm8pO1xuICAgIH0sXG5cbiAgICBhc3luYyBtYXhpbWl6ZVdpbmRvdyAoYnJvd3NlcklkKSB7XG4gICAgICAgIGNvbnN0IG1heGltdW1TaXplID0gZ2V0TWF4aW1pemVkSGVhZGxlc3NXaW5kb3dTaXplKCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5yZXNpemVXaW5kb3coYnJvd3NlcklkLCBtYXhpbXVtU2l6ZS53aWR0aCwgbWF4aW11bVNpemUuaGVpZ2h0LCBtYXhpbXVtU2l6ZS53aWR0aCwgbWF4aW11bVNpemUuaGVpZ2h0KTtcbiAgICB9LFxuXG4gICAgYXN5bmMgaGFzQ3VzdG9tQWN0aW9uRm9yQnJvd3NlciAoYnJvd3NlcklkKSB7XG4gICAgICAgIGNvbnN0IHsgY29uZmlnLCBjbGllbnQgfSA9IHRoaXMub3BlbmVkQnJvd3NlcnNbYnJvd3NlcklkXTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaGFzQ2xvc2VCcm93c2VyOiAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgaGFzUmVzaXplV2luZG93OiAgICAgICAgICAgICAgICAhIWNsaWVudCAmJiAoY29uZmlnLmVtdWxhdGlvbiB8fCBjb25maWcuaGVhZGxlc3MpLFxuICAgICAgICAgICAgaGFzTWF4aW1pemVXaW5kb3c6ICAgICAgICAgICAgICAhIWNsaWVudCAmJiBjb25maWcuaGVhZGxlc3MsXG4gICAgICAgICAgICBoYXNUYWtlU2NyZWVuc2hvdDogICAgICAgICAgICAgICEhY2xpZW50LFxuICAgICAgICAgICAgaGFzQ2hyb21lbGVzc1NjcmVlbnNob3RzOiAgICAgICAhIWNsaWVudCxcbiAgICAgICAgICAgIGhhc0NhblJlc2l6ZVdpbmRvd1RvRGltZW5zaW9uczogZmFsc2VcbiAgICAgICAgfTtcbiAgICB9XG59O1xuIl19
