'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _testcafeBrowserTools = require('testcafe-browser-tools');

var _testcafeBrowserTools2 = _interopRequireDefault(_testcafeBrowserTools);

var _osFamily = require('os-family');

var _osFamily2 = _interopRequireDefault(_osFamily);

var _connection = require('../connection');

var _connection2 = _interopRequireDefault(_connection);

var _delay = require('../../utils/delay');

var _delay2 = _interopRequireDefault(_delay);

var _clientFunctions = require('./utils/client-functions');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BROWSER_OPENING_DELAY = 2000;

const RESIZE_DIFF_SIZE = {
    width: 100,
    height: 100
};

function sumSizes(sizeA, sizeB) {
    return {
        width: sizeA.width + sizeB.width,
        height: sizeA.height + sizeB.height
    };
}

function subtractSizes(sizeA, sizeB) {
    return {
        width: sizeA.width - sizeB.width,
        height: sizeA.height - sizeB.height
    };
}

class BrowserProvider {
    constructor(plugin) {
        this.plugin = plugin;
        this.initPromise = _pinkie2.default.resolve(false);

        this.isMultiBrowser = this.plugin.isMultiBrowser;
        // HACK: The browser window has different border sizes in normal and maximized modes. So, we need to be sure that the window is
        // not maximized before resizing it in order to keep the mechanism of correcting the client area size working. When browser is started,
        // we are resizing it for the first time to switch the window to normal mode, and for the second time - to restore the client area size.
        this.localBrowsersInfo = {};
    }

    _createLocalBrowserInfo(browserId) {
        if (this.localBrowsersInfo[browserId]) return;

        this.localBrowsersInfo[browserId] = {
            windowDescriptor: null,
            maxScreenSize: null,
            resizeCorrections: null
        };
    }

    _getWindowDescriptor(browserId) {
        return this.localBrowsersInfo[browserId] && this.localBrowsersInfo[browserId].windowDescriptor;
    }

    _getMaxScreenSize(browserId) {
        return this.localBrowsersInfo[browserId] && this.localBrowsersInfo[browserId].maxScreenSize;
    }

    _getResizeCorrections(browserId) {
        return this.localBrowsersInfo[browserId] && this.localBrowsersInfo[browserId].resizeCorrections;
    }

    _isBrowserIdle(browserId) {
        const connection = _connection2.default.getById(browserId);

        return connection.idle;
    }

    _calculateResizeCorrections(browserId) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this._isBrowserIdle(browserId)) return;

            const title = yield _this.plugin.runInitScript(browserId, _clientFunctions.GET_TITLE_SCRIPT);

            if (!(yield _testcafeBrowserTools2.default.isMaximized(title))) return;

            const currentSize = yield _this.plugin.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);
            const etalonSize = subtractSizes(currentSize, RESIZE_DIFF_SIZE);

            yield _testcafeBrowserTools2.default.resize(title, currentSize.width, currentSize.height, etalonSize.width, etalonSize.height);

            let resizedSize = yield _this.plugin.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);
            let correctionSize = subtractSizes(resizedSize, etalonSize);

            yield _testcafeBrowserTools2.default.resize(title, resizedSize.width, resizedSize.height, etalonSize.width, etalonSize.height);

            resizedSize = yield _this.plugin.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

            correctionSize = sumSizes(correctionSize, subtractSizes(resizedSize, etalonSize));

            if (_this.localBrowsersInfo[browserId]) _this.localBrowsersInfo[browserId].resizeCorrections = correctionSize;

            yield _testcafeBrowserTools2.default.maximize(title);
        })();
    }

    _calculateMacSizeLimits(browserId) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this2._isBrowserIdle(browserId)) return;

            const sizeInfo = yield _this2.plugin.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

            if (_this2.localBrowsersInfo[browserId]) {
                _this2.localBrowsersInfo[browserId].maxScreenSize = {
                    width: sizeInfo.availableWidth - (sizeInfo.outerWidth - sizeInfo.width),
                    height: sizeInfo.availableHeight - (sizeInfo.outerHeight - sizeInfo.height)
                };
            }
        })();
    }

    _ensureBrowserWindowDescriptor(browserId) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this3._getWindowDescriptor(browserId)) return;

            yield _this3._createLocalBrowserInfo(browserId);

            // NOTE: delay to ensure the window finished the opening
            yield _this3.plugin.waitForConnectionReady(browserId);
            yield (0, _delay2.default)(BROWSER_OPENING_DELAY);

            if (_this3.localBrowsersInfo[browserId]) _this3.localBrowsersInfo[browserId].windowDescriptor = yield _testcafeBrowserTools2.default.findWindow(browserId);
        })();
    }

    _ensureBrowserWindowParameters(browserId) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this4._ensureBrowserWindowDescriptor(browserId);

            if (_osFamily2.default.win && !_this4._getResizeCorrections(browserId)) yield _this4._calculateResizeCorrections(browserId);else if (_osFamily2.default.mac && !_this4._getMaxScreenSize(browserId)) yield _this4._calculateMacSizeLimits(browserId);
        })();
    }

    _closeLocalBrowser(browserId) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _testcafeBrowserTools2.default.close(_this5._getWindowDescriptor(browserId));
        })();
    }

    _resizeLocalBrowserWindow(browserId, width, height, currentWidth, currentHeight) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const resizeCorrections = _this6._getResizeCorrections(browserId);

            if (resizeCorrections && (yield _testcafeBrowserTools2.default.isMaximized(_this6._getWindowDescriptor(browserId)))) {
                width -= resizeCorrections.width;
                height -= resizeCorrections.height;
            }

            yield _testcafeBrowserTools2.default.resize(_this6._getWindowDescriptor(browserId), currentWidth, currentHeight, width, height);
        })();
    }

    _takeLocalBrowserScreenshot(browserId, screenshotPath) {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _testcafeBrowserTools2.default.screenshot(_this7._getWindowDescriptor(browserId), screenshotPath);
        })();
    }

    _canResizeLocalBrowserWindowToDimensions(browserId, width, height) {
        var _this8 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_osFamily2.default.mac) return true;

            const maxScreenSize = _this8._getMaxScreenSize(browserId);

            return width <= maxScreenSize.width && height <= maxScreenSize.height;
        })();
    }

    _maximizeLocalBrowserWindow(browserId) {
        var _this9 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _testcafeBrowserTools2.default.maximize(_this9._getWindowDescriptor(browserId));
        })();
    }

    init() {
        var _this10 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const initialized = yield _this10.initPromise;

            if (initialized) return;

            _this10.initPromise = _this10.plugin.init().then(function () {
                return true;
            });

            try {
                yield _this10.initPromise;
            } catch (error) {
                _this10.initPromise = _pinkie2.default.resolve(false);

                throw error;
            }
        })();
    }

    dispose() {
        var _this11 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const initialized = yield _this11.initPromise;

            if (!initialized) return;

            _this11.initPromise = _this11.plugin.dispose().then(function () {
                return false;
            });

            try {
                yield _this11.initPromise;
            } catch (error) {
                _this11.initPromise = _pinkie2.default.resolve(false);

                throw error;
            }
        })();
    }

    isLocalBrowser(browserId, browserName) {
        var _this12 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this12.plugin.isLocalBrowser(browserId, browserName);
        })();
    }

    isHeadlessBrowser(browserId) {
        return this.plugin.isHeadlessBrowser(browserId);
    }

    openBrowser(browserId, pageUrl, browserName) {
        var _this13 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this13.plugin.openBrowser(browserId, pageUrl, browserName);

            const isLocalBrowser = yield _this13.plugin.isLocalBrowser(browserId);

            if (isLocalBrowser) yield _this13._ensureBrowserWindowParameters(browserId);
        })();
    }

    closeBrowser(browserId) {
        var _this14 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const isLocalBrowser = yield _this14.plugin.isLocalBrowser(browserId);
            const customActionsInfo = yield _this14.hasCustomActionForBrowser(browserId);
            const hasCustomCloseBrowser = customActionsInfo.hasCloseBrowser;
            const usePluginsCloseBrowser = hasCustomCloseBrowser || !isLocalBrowser;

            if (usePluginsCloseBrowser) yield _this14.plugin.closeBrowser(browserId);else yield _this14._closeLocalBrowser(browserId);

            if (isLocalBrowser) delete _this14.localBrowsersInfo[browserId];
        })();
    }

    getBrowserList() {
        var _this15 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this15.plugin.getBrowserList();
        })();
    }

    isValidBrowserName(browserName) {
        var _this16 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this16.plugin.isValidBrowserName(browserName);
        })();
    }

    resizeWindow(browserId, width, height, currentWidth, currentHeight) {
        var _this17 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const isLocalBrowser = yield _this17.plugin.isLocalBrowser(browserId);
            const customActionsInfo = yield _this17.hasCustomActionForBrowser(browserId);
            const hasCustomResizeWindow = customActionsInfo.hasResizeWindow;

            if (isLocalBrowser && !hasCustomResizeWindow) {
                yield _this17._resizeLocalBrowserWindow(browserId, width, height, currentWidth, currentHeight);
                return;
            }

            yield _this17.plugin.resizeWindow(browserId, width, height, currentWidth, currentHeight);
        })();
    }

    canResizeWindowToDimensions(browserId, width, height) {
        var _this18 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const isLocalBrowser = yield _this18.plugin.isLocalBrowser(browserId);
            const customActionsInfo = yield _this18.hasCustomActionForBrowser(browserId);
            const hasCustomCanResizeToDimensions = customActionsInfo.hasCanResizeWindowToDimensions;

            if (isLocalBrowser && !hasCustomCanResizeToDimensions) return yield _this18._canResizeLocalBrowserWindowToDimensions(browserId, width, height);

            return yield _this18.plugin.canResizeWindowToDimensions(browserId, width, height);
        })();
    }

    maximizeWindow(browserId) {
        var _this19 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const isLocalBrowser = yield _this19.plugin.isLocalBrowser(browserId);
            const customActionsInfo = yield _this19.hasCustomActionForBrowser(browserId);
            const hasCustomMaximizeWindow = customActionsInfo.hasMaximizeWindow;

            if (isLocalBrowser && !hasCustomMaximizeWindow) return yield _this19._maximizeLocalBrowserWindow(browserId);

            return yield _this19.plugin.maximizeWindow(browserId);
        })();
    }

    takeScreenshot(browserId, screenshotPath, pageWidth, pageHeight) {
        var _this20 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const isLocalBrowser = yield _this20.plugin.isLocalBrowser(browserId);
            const customActionsInfo = yield _this20.hasCustomActionForBrowser(browserId);
            const hasCustomTakeScreenshot = customActionsInfo.hasTakeScreenshot;

            if (isLocalBrowser && !hasCustomTakeScreenshot) {
                yield _this20._takeLocalBrowserScreenshot(browserId, screenshotPath, pageWidth, pageHeight);
                return;
            }

            yield _this20.plugin.takeScreenshot(browserId, screenshotPath, pageWidth, pageHeight);
        })();
    }

    hasCustomActionForBrowser(browserId) {
        var _this21 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return _this21.plugin.hasCustomActionForBrowser(browserId);
        })();
    }

    reportJobResult(browserId, status, data) {
        var _this22 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this22.plugin.reportJobResult(browserId, status, data);
        })();
    }
}
exports.default = BrowserProvider;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2luZGV4LmpzIl0sIm5hbWVzIjpbIkJST1dTRVJfT1BFTklOR19ERUxBWSIsIlJFU0laRV9ESUZGX1NJWkUiLCJ3aWR0aCIsImhlaWdodCIsInN1bVNpemVzIiwic2l6ZUEiLCJzaXplQiIsInN1YnRyYWN0U2l6ZXMiLCJCcm93c2VyUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsInBsdWdpbiIsImluaXRQcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJpc011bHRpQnJvd3NlciIsImxvY2FsQnJvd3NlcnNJbmZvIiwiX2NyZWF0ZUxvY2FsQnJvd3NlckluZm8iLCJicm93c2VySWQiLCJ3aW5kb3dEZXNjcmlwdG9yIiwibWF4U2NyZWVuU2l6ZSIsInJlc2l6ZUNvcnJlY3Rpb25zIiwiX2dldFdpbmRvd0Rlc2NyaXB0b3IiLCJfZ2V0TWF4U2NyZWVuU2l6ZSIsIl9nZXRSZXNpemVDb3JyZWN0aW9ucyIsIl9pc0Jyb3dzZXJJZGxlIiwiY29ubmVjdGlvbiIsIkJyb3dzZXJDb25uZWN0aW9uIiwiZ2V0QnlJZCIsImlkbGUiLCJfY2FsY3VsYXRlUmVzaXplQ29ycmVjdGlvbnMiLCJ0aXRsZSIsInJ1bkluaXRTY3JpcHQiLCJHRVRfVElUTEVfU0NSSVBUIiwiYnJvd3NlclRvb2xzIiwiaXNNYXhpbWl6ZWQiLCJjdXJyZW50U2l6ZSIsIkdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCIsImV0YWxvblNpemUiLCJyZXNpemUiLCJyZXNpemVkU2l6ZSIsImNvcnJlY3Rpb25TaXplIiwibWF4aW1pemUiLCJfY2FsY3VsYXRlTWFjU2l6ZUxpbWl0cyIsInNpemVJbmZvIiwiYXZhaWxhYmxlV2lkdGgiLCJvdXRlcldpZHRoIiwiYXZhaWxhYmxlSGVpZ2h0Iiwib3V0ZXJIZWlnaHQiLCJfZW5zdXJlQnJvd3NlcldpbmRvd0Rlc2NyaXB0b3IiLCJ3YWl0Rm9yQ29ubmVjdGlvblJlYWR5IiwiZmluZFdpbmRvdyIsIl9lbnN1cmVCcm93c2VyV2luZG93UGFyYW1ldGVycyIsIk9TIiwid2luIiwibWFjIiwiX2Nsb3NlTG9jYWxCcm93c2VyIiwiY2xvc2UiLCJfcmVzaXplTG9jYWxCcm93c2VyV2luZG93IiwiY3VycmVudFdpZHRoIiwiY3VycmVudEhlaWdodCIsIl90YWtlTG9jYWxCcm93c2VyU2NyZWVuc2hvdCIsInNjcmVlbnNob3RQYXRoIiwic2NyZWVuc2hvdCIsIl9jYW5SZXNpemVMb2NhbEJyb3dzZXJXaW5kb3dUb0RpbWVuc2lvbnMiLCJfbWF4aW1pemVMb2NhbEJyb3dzZXJXaW5kb3ciLCJpbml0IiwiaW5pdGlhbGl6ZWQiLCJ0aGVuIiwiZXJyb3IiLCJkaXNwb3NlIiwiaXNMb2NhbEJyb3dzZXIiLCJicm93c2VyTmFtZSIsImlzSGVhZGxlc3NCcm93c2VyIiwib3BlbkJyb3dzZXIiLCJwYWdlVXJsIiwiY2xvc2VCcm93c2VyIiwiY3VzdG9tQWN0aW9uc0luZm8iLCJoYXNDdXN0b21BY3Rpb25Gb3JCcm93c2VyIiwiaGFzQ3VzdG9tQ2xvc2VCcm93c2VyIiwiaGFzQ2xvc2VCcm93c2VyIiwidXNlUGx1Z2luc0Nsb3NlQnJvd3NlciIsImdldEJyb3dzZXJMaXN0IiwiaXNWYWxpZEJyb3dzZXJOYW1lIiwicmVzaXplV2luZG93IiwiaGFzQ3VzdG9tUmVzaXplV2luZG93IiwiaGFzUmVzaXplV2luZG93IiwiY2FuUmVzaXplV2luZG93VG9EaW1lbnNpb25zIiwiaGFzQ3VzdG9tQ2FuUmVzaXplVG9EaW1lbnNpb25zIiwiaGFzQ2FuUmVzaXplV2luZG93VG9EaW1lbnNpb25zIiwibWF4aW1pemVXaW5kb3ciLCJoYXNDdXN0b21NYXhpbWl6ZVdpbmRvdyIsImhhc01heGltaXplV2luZG93IiwidGFrZVNjcmVlbnNob3QiLCJwYWdlV2lkdGgiLCJwYWdlSGVpZ2h0IiwiaGFzQ3VzdG9tVGFrZVNjcmVlbnNob3QiLCJoYXNUYWtlU2NyZWVuc2hvdCIsInJlcG9ydEpvYlJlc3VsdCIsInN0YXR1cyIsImRhdGEi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QUFqQyxFQUE0QzRDLGNBQTVDLEVBQTREZ0MsU0FBNUQsRUFBdUVDLFVBQXZFLENBQU47QUFDQTtBQUNIOztBQUVELGtCQUFNLFFBQUtwRixNQUFMLENBQVlrRixjQUFaLENBQTJCM0UsU0FBM0IsRUFBc0M0QyxjQUF0QyxFQUFzRGdDLFNBQXRELEVBQWlFQyxVQUFqRSxDQUFOO0FBVm9FO0FBV3ZFOztBQUVLakIsNkJBQU4sQ0FBaUM1RCxTQUFqQyxFQUE0QztBQUFBOztBQUFBO0FBQ3hDLG1CQUFPLFFBQUtQLE1BQUwsQ0FBWW1FLHlCQUFaLENBQXNDNUQsU0FBdEMsQ0FBUDtBQUR3QztBQUUzQzs7QUFFS2dGLG1CQUFOLENBQXVCaEYsU0FBdkIsRUFBa0NpRixNQUFsQyxFQUEwQ0MsSUFBMUMsRUFBZ0Q7QUFBQTs7QUFBQTtBQUM1QyxrQkFBTSxRQUFLekYsTUFBTCxDQUFZdUYsZUFBWixDQUE0QmhGLFNBQTVCLEVBQXVDaUYsTUFBdkMsRUFBK0NDLElBQS9DLENBQU47QUFENEM7QUFFL0M7QUFwUmdDO2tCQUFoQjNGLGUiLCJmaWxlIjoiYnJvd3Nlci9wcm92aWRlci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgYnJvd3NlclRvb2xzIGZyb20gJ3Rlc3RjYWZlLWJyb3dzZXItdG9vbHMnO1xuaW1wb3J0IE9TIGZyb20gJ29zLWZhbWlseSc7XG5pbXBvcnQgQnJvd3NlckNvbm5lY3Rpb24gZnJvbSAnLi4vY29ubmVjdGlvbic7XG5pbXBvcnQgZGVsYXkgZnJvbSAnLi4vLi4vdXRpbHMvZGVsYXknO1xuaW1wb3J0IHsgR0VUX1RJVExFX1NDUklQVCwgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUIH0gZnJvbSAnLi91dGlscy9jbGllbnQtZnVuY3Rpb25zJztcblxuXG5jb25zdCBCUk9XU0VSX09QRU5JTkdfREVMQVkgPSAyMDAwO1xuXG5jb25zdCBSRVNJWkVfRElGRl9TSVpFID0ge1xuICAgIHdpZHRoOiAgMTAwLFxuICAgIGhlaWdodDogMTAwXG59O1xuXG5cbmZ1bmN0aW9uIHN1bVNpemVzIChzaXplQSwgc2l6ZUIpIHtcbiAgICByZXR1cm4ge1xuICAgICAgICB3aWR0aDogIHNpemVBLndpZHRoICsgc2l6ZUIud2lkdGgsXG4gICAgICAgIGhlaWdodDogc2l6ZUEuaGVpZ2h0ICsgc2l6ZUIuaGVpZ2h0XG4gICAgfTtcbn1cblxuZnVuY3Rpb24gc3VidHJhY3RTaXplcyAoc2l6ZUEsIHNpemVCKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgd2lkdGg6ICBzaXplQS53aWR0aCAtIHNpemVCLndpZHRoLFxuICAgICAgICBoZWlnaHQ6IHNpemVBLmhlaWdodCAtIHNpemVCLmhlaWdodFxuICAgIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJyb3dzZXJQcm92aWRlciB7XG4gICAgY29uc3RydWN0b3IgKHBsdWdpbikge1xuICAgICAgICB0aGlzLnBsdWdpbiAgICAgID0gcGx1Z2luO1xuICAgICAgICB0aGlzLmluaXRQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTtcblxuICAgICAgICB0aGlzLmlzTXVsdGlCcm93c2VyID0gdGhpcy5wbHVnaW4uaXNNdWx0aUJyb3dzZXI7XG4gICAgICAgIC8vIEhBQ0s6IFRoZSBicm93c2VyIHdpbmRvdyBoYXMgZGlmZmVyZW50IGJvcmRlciBzaXplcyBpbiBub3JtYWwgYW5kIG1heGltaXplZCBtb2Rlcy4gU28sIHdlIG5lZWQgdG8gYmUgc3VyZSB0aGF0IHRoZSB3aW5kb3cgaXNcbiAgICAgICAgLy8gbm90IG1heGltaXplZCBiZWZvcmUgcmVzaXppbmcgaXQgaW4gb3JkZXIgdG8ga2VlcCB0aGUgbWVjaGFuaXNtIG9mIGNvcnJlY3RpbmcgdGhlIGNsaWVudCBhcmVhIHNpemUgd29ya2luZy4gV2hlbiBicm93c2VyIGlzIHN0YXJ0ZWQsXG4gICAgICAgIC8vIHdlIGFyZSByZXNpemluZyBpdCBmb3IgdGhlIGZpcnN0IHRpbWUgdG8gc3dpdGNoIHRoZSB3aW5kb3cgdG8gbm9ybWFsIG1vZGUsIGFuZCBmb3IgdGhlIHNlY29uZCB0aW1lIC0gdG8gcmVzdG9yZSB0aGUgY2xpZW50IGFyZWEgc2l6ZS5cbiAgICAgICAgdGhpcy5sb2NhbEJyb3dzZXJzSW5mbyA9IHt9O1xuICAgIH1cblxuICAgIF9jcmVhdGVMb2NhbEJyb3dzZXJJbmZvIChicm93c2VySWQpIHtcbiAgICAgICAgaWYgKHRoaXMubG9jYWxCcm93c2Vyc0luZm9bYnJvd3NlcklkXSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0gPSB7XG4gICAgICAgICAgICB3aW5kb3dEZXNjcmlwdG9yOiAgbnVsbCxcbiAgICAgICAgICAgIG1heFNjcmVlblNpemU6ICAgICBudWxsLFxuICAgICAgICAgICAgcmVzaXplQ29ycmVjdGlvbnM6IG51bGxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfZ2V0V2luZG93RGVzY3JpcHRvciAoYnJvd3NlcklkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0gJiYgdGhpcy5sb2NhbEJyb3dzZXJzSW5mb1ticm93c2VySWRdLndpbmRvd0Rlc2NyaXB0b3I7XG4gICAgfVxuXG4gICAgX2dldE1heFNjcmVlblNpemUgKGJyb3dzZXJJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2NhbEJyb3dzZXJzSW5mb1ticm93c2VySWRdICYmIHRoaXMubG9jYWxCcm93c2Vyc0luZm9bYnJvd3NlcklkXS5tYXhTY3JlZW5TaXplO1xuICAgIH1cblxuICAgIF9nZXRSZXNpemVDb3JyZWN0aW9ucyAoYnJvd3NlcklkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0gJiYgdGhpcy5sb2NhbEJyb3dzZXJzSW5mb1ticm93c2VySWRdLnJlc2l6ZUNvcnJlY3Rpb25zO1xuICAgIH1cblxuICAgIF9pc0Jyb3dzZXJJZGxlIChicm93c2VySWQpIHtcbiAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IEJyb3dzZXJDb25uZWN0aW9uLmdldEJ5SWQoYnJvd3NlcklkKTtcblxuICAgICAgICByZXR1cm4gY29ubmVjdGlvbi5pZGxlO1xuICAgIH1cblxuICAgIGFzeW5jIF9jYWxjdWxhdGVSZXNpemVDb3JyZWN0aW9ucyAoYnJvd3NlcklkKSB7XG4gICAgICAgIGlmICghdGhpcy5faXNCcm93c2VySWRsZShicm93c2VySWQpKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IHRpdGxlID0gYXdhaXQgdGhpcy5wbHVnaW4ucnVuSW5pdFNjcmlwdChicm93c2VySWQsIEdFVF9USVRMRV9TQ1JJUFQpO1xuXG4gICAgICAgIGlmICghYXdhaXQgYnJvd3NlclRvb2xzLmlzTWF4aW1pemVkKHRpdGxlKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjb25zdCBjdXJyZW50U2l6ZSA9IGF3YWl0IHRoaXMucGx1Z2luLnJ1bkluaXRTY3JpcHQoYnJvd3NlcklkLCBHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFQpO1xuICAgICAgICBjb25zdCBldGFsb25TaXplICA9IHN1YnRyYWN0U2l6ZXMoY3VycmVudFNpemUsIFJFU0laRV9ESUZGX1NJWkUpO1xuXG4gICAgICAgIGF3YWl0IGJyb3dzZXJUb29scy5yZXNpemUodGl0bGUsIGN1cnJlbnRTaXplLndpZHRoLCBjdXJyZW50U2l6ZS5oZWlnaHQsIGV0YWxvblNpemUud2lkdGgsIGV0YWxvblNpemUuaGVpZ2h0KTtcblxuICAgICAgICBsZXQgcmVzaXplZFNpemUgICAgPSBhd2FpdCB0aGlzLnBsdWdpbi5ydW5Jbml0U2NyaXB0KGJyb3dzZXJJZCwgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUKTtcbiAgICAgICAgbGV0IGNvcnJlY3Rpb25TaXplID0gc3VidHJhY3RTaXplcyhyZXNpemVkU2l6ZSwgZXRhbG9uU2l6ZSk7XG5cbiAgICAgICAgYXdhaXQgYnJvd3NlclRvb2xzLnJlc2l6ZSh0aXRsZSwgcmVzaXplZFNpemUud2lkdGgsIHJlc2l6ZWRTaXplLmhlaWdodCwgZXRhbG9uU2l6ZS53aWR0aCwgZXRhbG9uU2l6ZS5oZWlnaHQpO1xuXG4gICAgICAgIHJlc2l6ZWRTaXplID0gYXdhaXQgdGhpcy5wbHVnaW4ucnVuSW5pdFNjcmlwdChicm93c2VySWQsIEdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCk7XG5cbiAgICAgICAgY29ycmVjdGlvblNpemUgPSBzdW1TaXplcyhjb3JyZWN0aW9uU2l6ZSwgc3VidHJhY3RTaXplcyhyZXNpemVkU2l6ZSwgZXRhbG9uU2l6ZSkpO1xuXG4gICAgICAgIGlmICh0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0pXG4gICAgICAgICAgICB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0ucmVzaXplQ29ycmVjdGlvbnMgPSBjb3JyZWN0aW9uU2l6ZTtcblxuICAgICAgICBhd2FpdCBicm93c2VyVG9vbHMubWF4aW1pemUodGl0bGUpO1xuICAgIH1cblxuXG4gICAgYXN5bmMgX2NhbGN1bGF0ZU1hY1NpemVMaW1pdHMgKGJyb3dzZXJJZCkge1xuICAgICAgICBpZiAoIXRoaXMuX2lzQnJvd3NlcklkbGUoYnJvd3NlcklkKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjb25zdCBzaXplSW5mbyA9IGF3YWl0IHRoaXMucGx1Z2luLnJ1bkluaXRTY3JpcHQoYnJvd3NlcklkLCBHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFQpO1xuXG4gICAgICAgIGlmICh0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0pIHtcbiAgICAgICAgICAgIHRoaXMubG9jYWxCcm93c2Vyc0luZm9bYnJvd3NlcklkXS5tYXhTY3JlZW5TaXplID0ge1xuICAgICAgICAgICAgICAgIHdpZHRoOiAgc2l6ZUluZm8uYXZhaWxhYmxlV2lkdGggLSAoc2l6ZUluZm8ub3V0ZXJXaWR0aCAtIHNpemVJbmZvLndpZHRoKSxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IHNpemVJbmZvLmF2YWlsYWJsZUhlaWdodCAtIChzaXplSW5mby5vdXRlckhlaWdodCAtIHNpemVJbmZvLmhlaWdodClcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfZW5zdXJlQnJvd3NlcldpbmRvd0Rlc2NyaXB0b3IgKGJyb3dzZXJJZCkge1xuICAgICAgICBpZiAodGhpcy5fZ2V0V2luZG93RGVzY3JpcHRvcihicm93c2VySWQpKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuX2NyZWF0ZUxvY2FsQnJvd3NlckluZm8oYnJvd3NlcklkKTtcblxuICAgICAgICAvLyBOT1RFOiBkZWxheSB0byBlbnN1cmUgdGhlIHdpbmRvdyBmaW5pc2hlZCB0aGUgb3BlbmluZ1xuICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi53YWl0Rm9yQ29ubmVjdGlvblJlYWR5KGJyb3dzZXJJZCk7XG4gICAgICAgIGF3YWl0IGRlbGF5KEJST1dTRVJfT1BFTklOR19ERUxBWSk7XG5cbiAgICAgICAgaWYgKHRoaXMubG9jYWxCcm93c2Vyc0luZm9bYnJvd3NlcklkXSlcbiAgICAgICAgICAgIHRoaXMubG9jYWxCcm93c2Vyc0luZm9bYnJvd3NlcklkXS53aW5kb3dEZXNjcmlwdG9yID0gYXdhaXQgYnJvd3NlclRvb2xzLmZpbmRXaW5kb3coYnJvd3NlcklkKTtcbiAgICB9XG5cbiAgICBhc3luYyBfZW5zdXJlQnJvd3NlcldpbmRvd1BhcmFtZXRlcnMgKGJyb3dzZXJJZCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9lbnN1cmVCcm93c2VyV2luZG93RGVzY3JpcHRvcihicm93c2VySWQpO1xuXG4gICAgICAgIGlmIChPUy53aW4gJiYgIXRoaXMuX2dldFJlc2l6ZUNvcnJlY3Rpb25zKGJyb3dzZXJJZCkpXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9jYWxjdWxhdGVSZXNpemVDb3JyZWN0aW9ucyhicm93c2VySWQpO1xuICAgICAgICBlbHNlIGlmIChPUy5tYWMgJiYgIXRoaXMuX2dldE1heFNjcmVlblNpemUoYnJvd3NlcklkKSlcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2NhbGN1bGF0ZU1hY1NpemVMaW1pdHMoYnJvd3NlcklkKTtcbiAgICB9XG5cbiAgICBhc3luYyBfY2xvc2VMb2NhbEJyb3dzZXIgKGJyb3dzZXJJZCkge1xuICAgICAgICBhd2FpdCBicm93c2VyVG9vbHMuY2xvc2UodGhpcy5fZ2V0V2luZG93RGVzY3JpcHRvcihicm93c2VySWQpKTtcbiAgICB9XG5cbiAgICBhc3luYyBfcmVzaXplTG9jYWxCcm93c2VyV2luZG93IChicm93c2VySWQsIHdpZHRoLCBoZWlnaHQsIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCkge1xuICAgICAgICBjb25zdCByZXNpemVDb3JyZWN0aW9ucyA9IHRoaXMuX2dldFJlc2l6ZUNvcnJlY3Rpb25zKGJyb3dzZXJJZCk7XG5cbiAgICAgICAgaWYgKHJlc2l6ZUNvcnJlY3Rpb25zICYmIGF3YWl0IGJyb3dzZXJUb29scy5pc01heGltaXplZCh0aGlzLl9nZXRXaW5kb3dEZXNjcmlwdG9yKGJyb3dzZXJJZCkpKSB7XG4gICAgICAgICAgICB3aWR0aCAtPSByZXNpemVDb3JyZWN0aW9ucy53aWR0aDtcbiAgICAgICAgICAgIGhlaWdodCAtPSByZXNpemVDb3JyZWN0aW9ucy5oZWlnaHQ7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBicm93c2VyVG9vbHMucmVzaXplKHRoaXMuX2dldFdpbmRvd0Rlc2NyaXB0b3IoYnJvd3NlcklkKSwgY3VycmVudFdpZHRoLCBjdXJyZW50SGVpZ2h0LCB3aWR0aCwgaGVpZ2h0KTtcbiAgICB9XG5cbiAgICBhc3luYyBfdGFrZUxvY2FsQnJvd3NlclNjcmVlbnNob3QgKGJyb3dzZXJJZCwgc2NyZWVuc2hvdFBhdGgpIHtcbiAgICAgICAgYXdhaXQgYnJvd3NlclRvb2xzLnNjcmVlbnNob3QodGhpcy5fZ2V0V2luZG93RGVzY3JpcHRvcihicm93c2VySWQpLCBzY3JlZW5zaG90UGF0aCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2NhblJlc2l6ZUxvY2FsQnJvd3NlcldpbmRvd1RvRGltZW5zaW9ucyAoYnJvd3NlcklkLCB3aWR0aCwgaGVpZ2h0KSB7XG4gICAgICAgIGlmICghT1MubWFjKVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG5cbiAgICAgICAgY29uc3QgbWF4U2NyZWVuU2l6ZSA9IHRoaXMuX2dldE1heFNjcmVlblNpemUoYnJvd3NlcklkKTtcblxuICAgICAgICByZXR1cm4gd2lkdGggPD0gbWF4U2NyZWVuU2l6ZS53aWR0aCAmJiBoZWlnaHQgPD0gbWF4U2NyZWVuU2l6ZS5oZWlnaHQ7XG4gICAgfVxuXG4gICAgYXN5bmMgX21heGltaXplTG9jYWxCcm93c2VyV2luZG93IChicm93c2VySWQpIHtcbiAgICAgICAgYXdhaXQgYnJvd3NlclRvb2xzLm1heGltaXplKHRoaXMuX2dldFdpbmRvd0Rlc2NyaXB0b3IoYnJvd3NlcklkKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgaW5pdCAoKSB7XG4gICAgICAgIGNvbnN0IGluaXRpYWxpemVkID0gYXdhaXQgdGhpcy5pbml0UHJvbWlzZTtcblxuICAgICAgICBpZiAoaW5pdGlhbGl6ZWQpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5pbml0UHJvbWlzZSA9IHRoaXMucGx1Z2luXG4gICAgICAgICAgICAuaW5pdCgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0cnVlKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5pbml0UHJvbWlzZTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdFByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGRpc3Bvc2UgKCkge1xuICAgICAgICBjb25zdCBpbml0aWFsaXplZCA9IGF3YWl0IHRoaXMuaW5pdFByb21pc2U7XG5cbiAgICAgICAgaWYgKCFpbml0aWFsaXplZClcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB0aGlzLmluaXRQcm9taXNlID0gdGhpcy5wbHVnaW5cbiAgICAgICAgICAgIC5kaXNwb3NlKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IGZhbHNlKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5pbml0UHJvbWlzZTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdFByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGlzTG9jYWxCcm93c2VyIChicm93c2VySWQsIGJyb3dzZXJOYW1lKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnBsdWdpbi5pc0xvY2FsQnJvd3Nlcihicm93c2VySWQsIGJyb3dzZXJOYW1lKTtcbiAgICB9XG5cbiAgICBpc0hlYWRsZXNzQnJvd3NlciAoYnJvd3NlcklkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBsdWdpbi5pc0hlYWRsZXNzQnJvd3Nlcihicm93c2VySWQpO1xuICAgIH1cblxuICAgIGFzeW5jIG9wZW5Ccm93c2VyIChicm93c2VySWQsIHBhZ2VVcmwsIGJyb3dzZXJOYW1lKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLm9wZW5Ccm93c2VyKGJyb3dzZXJJZCwgcGFnZVVybCwgYnJvd3Nlck5hbWUpO1xuXG4gICAgICAgIGNvbnN0IGlzTG9jYWxCcm93c2VyID0gYXdhaXQgdGhpcy5wbHVnaW4uaXNMb2NhbEJyb3dzZXIoYnJvd3NlcklkKTtcblxuICAgICAgICBpZiAoaXNMb2NhbEJyb3dzZXIpXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9lbnN1cmVCcm93c2VyV2luZG93UGFyYW1ldGVycyhicm93c2VySWQpO1xuICAgIH1cblxuICAgIGFzeW5jIGNsb3NlQnJvd3NlciAoYnJvd3NlcklkKSB7XG4gICAgICAgIGNvbnN0IGlzTG9jYWxCcm93c2VyICAgICAgICAgPSBhd2FpdCB0aGlzLnBsdWdpbi5pc0xvY2FsQnJvd3Nlcihicm93c2VySWQpO1xuICAgICAgICBjb25zdCBjdXN0b21BY3Rpb25zSW5mbyAgICAgID0gYXdhaXQgdGhpcy5oYXNDdXN0b21BY3Rpb25Gb3JCcm93c2VyKGJyb3dzZXJJZCk7XG4gICAgICAgIGNvbnN0IGhhc0N1c3RvbUNsb3NlQnJvd3NlciAgPSBjdXN0b21BY3Rpb25zSW5mby5oYXNDbG9zZUJyb3dzZXI7XG4gICAgICAgIGNvbnN0IHVzZVBsdWdpbnNDbG9zZUJyb3dzZXIgPSBoYXNDdXN0b21DbG9zZUJyb3dzZXIgfHwgIWlzTG9jYWxCcm93c2VyO1xuXG4gICAgICAgIGlmICh1c2VQbHVnaW5zQ2xvc2VCcm93c2VyKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW4uY2xvc2VCcm93c2VyKGJyb3dzZXJJZCk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2Nsb3NlTG9jYWxCcm93c2VyKGJyb3dzZXJJZCk7XG5cbiAgICAgICAgaWYgKGlzTG9jYWxCcm93c2VyKVxuICAgICAgICAgICAgZGVsZXRlIHRoaXMubG9jYWxCcm93c2Vyc0luZm9bYnJvd3NlcklkXTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRCcm93c2VyTGlzdCAoKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnBsdWdpbi5nZXRCcm93c2VyTGlzdCgpO1xuICAgIH1cblxuICAgIGFzeW5jIGlzVmFsaWRCcm93c2VyTmFtZSAoYnJvd3Nlck5hbWUpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucGx1Z2luLmlzVmFsaWRCcm93c2VyTmFtZShicm93c2VyTmFtZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVzaXplV2luZG93IChicm93c2VySWQsIHdpZHRoLCBoZWlnaHQsIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCkge1xuICAgICAgICBjb25zdCBpc0xvY2FsQnJvd3NlciAgICAgICAgPSBhd2FpdCB0aGlzLnBsdWdpbi5pc0xvY2FsQnJvd3Nlcihicm93c2VySWQpO1xuICAgICAgICBjb25zdCBjdXN0b21BY3Rpb25zSW5mbyAgICAgPSBhd2FpdCB0aGlzLmhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIoYnJvd3NlcklkKTtcbiAgICAgICAgY29uc3QgaGFzQ3VzdG9tUmVzaXplV2luZG93ID0gY3VzdG9tQWN0aW9uc0luZm8uaGFzUmVzaXplV2luZG93O1xuXG5cbiAgICAgICAgaWYgKGlzTG9jYWxCcm93c2VyICYmICFoYXNDdXN0b21SZXNpemVXaW5kb3cpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Jlc2l6ZUxvY2FsQnJvd3NlcldpbmRvdyhicm93c2VySWQsIHdpZHRoLCBoZWlnaHQsIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi5yZXNpemVXaW5kb3coYnJvd3NlcklkLCB3aWR0aCwgaGVpZ2h0LCBjdXJyZW50V2lkdGgsIGN1cnJlbnRIZWlnaHQpO1xuICAgIH1cblxuICAgIGFzeW5jIGNhblJlc2l6ZVdpbmRvd1RvRGltZW5zaW9ucyAoYnJvd3NlcklkLCB3aWR0aCwgaGVpZ2h0KSB7XG4gICAgICAgIGNvbnN0IGlzTG9jYWxCcm93c2VyICAgICAgICAgICAgICAgICA9IGF3YWl0IHRoaXMucGx1Z2luLmlzTG9jYWxCcm93c2VyKGJyb3dzZXJJZCk7XG4gICAgICAgIGNvbnN0IGN1c3RvbUFjdGlvbnNJbmZvICAgICAgICAgICAgICA9IGF3YWl0IHRoaXMuaGFzQ3VzdG9tQWN0aW9uRm9yQnJvd3Nlcihicm93c2VySWQpO1xuICAgICAgICBjb25zdCBoYXNDdXN0b21DYW5SZXNpemVUb0RpbWVuc2lvbnMgPSBjdXN0b21BY3Rpb25zSW5mby5oYXNDYW5SZXNpemVXaW5kb3dUb0RpbWVuc2lvbnM7XG5cblxuICAgICAgICBpZiAoaXNMb2NhbEJyb3dzZXIgJiYgIWhhc0N1c3RvbUNhblJlc2l6ZVRvRGltZW5zaW9ucylcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9jYW5SZXNpemVMb2NhbEJyb3dzZXJXaW5kb3dUb0RpbWVuc2lvbnMoYnJvd3NlcklkLCB3aWR0aCwgaGVpZ2h0KTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wbHVnaW4uY2FuUmVzaXplV2luZG93VG9EaW1lbnNpb25zKGJyb3dzZXJJZCwgd2lkdGgsIGhlaWdodCk7XG4gICAgfVxuXG4gICAgYXN5bmMgbWF4aW1pemVXaW5kb3cgKGJyb3dzZXJJZCkge1xuICAgICAgICBjb25zdCBpc0xvY2FsQnJvd3NlciAgICAgICAgICA9IGF3YWl0IHRoaXMucGx1Z2luLmlzTG9jYWxCcm93c2VyKGJyb3dzZXJJZCk7XG4gICAgICAgIGNvbnN0IGN1c3RvbUFjdGlvbnNJbmZvICAgICAgID0gYXdhaXQgdGhpcy5oYXNDdXN0b21BY3Rpb25Gb3JCcm93c2VyKGJyb3dzZXJJZCk7XG4gICAgICAgIGNvbnN0IGhhc0N1c3RvbU1heGltaXplV2luZG93ID0gY3VzdG9tQWN0aW9uc0luZm8uaGFzTWF4aW1pemVXaW5kb3c7XG5cbiAgICAgICAgaWYgKGlzTG9jYWxCcm93c2VyICYmICFoYXNDdXN0b21NYXhpbWl6ZVdpbmRvdylcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9tYXhpbWl6ZUxvY2FsQnJvd3NlcldpbmRvdyhicm93c2VySWQpO1xuXG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnBsdWdpbi5tYXhpbWl6ZVdpbmRvdyhicm93c2VySWQpO1xuICAgIH1cblxuICAgIGFzeW5jIHRha2VTY3JlZW5zaG90IChicm93c2VySWQsIHNjcmVlbnNob3RQYXRoLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQpIHtcbiAgICAgICAgY29uc3QgaXNMb2NhbEJyb3dzZXIgICAgICAgICAgPSBhd2FpdCB0aGlzLnBsdWdpbi5pc0xvY2FsQnJvd3Nlcihicm93c2VySWQpO1xuICAgICAgICBjb25zdCBjdXN0b21BY3Rpb25zSW5mbyAgICAgICA9IGF3YWl0IHRoaXMuaGFzQ3VzdG9tQWN0aW9uRm9yQnJvd3Nlcihicm93c2VySWQpO1xuICAgICAgICBjb25zdCBoYXNDdXN0b21UYWtlU2NyZWVuc2hvdCA9IGN1c3RvbUFjdGlvbnNJbmZvLmhhc1Rha2VTY3JlZW5zaG90O1xuXG4gICAgICAgIGlmIChpc0xvY2FsQnJvd3NlciAmJiAhaGFzQ3VzdG9tVGFrZVNjcmVlbnNob3QpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Rha2VMb2NhbEJyb3dzZXJTY3JlZW5zaG90KGJyb3dzZXJJZCwgc2NyZWVuc2hvdFBhdGgsIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi50YWtlU2NyZWVuc2hvdChicm93c2VySWQsIHNjcmVlbnNob3RQYXRoLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQpO1xuICAgIH1cblxuICAgIGFzeW5jIGhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIgKGJyb3dzZXJJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wbHVnaW4uaGFzQ3VzdG9tQWN0aW9uRm9yQnJvd3Nlcihicm93c2VySWQpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlcG9ydEpvYlJlc3VsdCAoYnJvd3NlcklkLCBzdGF0dXMsIGRhdGEpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW4ucmVwb3J0Sm9iUmVzdWx0KGJyb3dzZXJJZCwgc3RhdHVzLCBkYXRhKTtcbiAgICB9XG59XG4iXX0=
