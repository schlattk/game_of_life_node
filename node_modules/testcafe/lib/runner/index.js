'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _path = require('path');

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _mapReverse = require('map-reverse');

var _mapReverse2 = _interopRequireDefault(_mapReverse);

var _events = require('events');

var _lodash = require('lodash');

var _bootstrapper = require('./bootstrapper');

var _bootstrapper2 = _interopRequireDefault(_bootstrapper);

var _reporter = require('../reporter');

var _reporter2 = _interopRequireDefault(_reporter);

var _task = require('./task');

var _task2 = _interopRequireDefault(_task);

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _typeAssertions = require('../errors/runtime/type-assertions');

var _renderForbiddenCharsList = require('../errors/render-forbidden-chars-list');

var _renderForbiddenCharsList2 = _interopRequireDefault(_renderForbiddenCharsList);

var _checkFilePath = require('../utils/check-file-path');

var _checkFilePath2 = _interopRequireDefault(_checkFilePath);

var _handleErrors = require('../utils/handle-errors');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_SELECTOR_TIMEOUT = 10000;
const DEFAULT_ASSERTION_TIMEOUT = 3000;
const DEFAULT_PAGE_LOAD_TIMEOUT = 3000;

class Runner extends _events.EventEmitter {
    constructor(proxy, browserConnectionGateway, options = {}) {
        super();

        this.proxy = proxy;
        this.bootstrapper = new _bootstrapper2.default(browserConnectionGateway);
        this.pendingTaskPromises = [];

        this.opts = {
            externalProxyHost: null,
            proxyBypass: null,
            screenshotPath: null,
            takeScreenshotsOnFails: false,
            screenshotPathPattern: null,
            skipJsErrors: false,
            quarantineMode: false,
            debugMode: false,
            retryTestPages: options.retryTestPages,
            selectorTimeout: DEFAULT_SELECTOR_TIMEOUT,
            pageLoadTimeout: DEFAULT_PAGE_LOAD_TIMEOUT
        };
    }

    static _disposeTaskAndRelatedAssets(task, browserSet, testedApp) {
        return (0, _asyncToGenerator3.default)(function* () {
            task.abort();
            task.removeAllListeners();

            yield Runner._disposeBrowserSetAndTestedApp(browserSet, testedApp);
        })();
    }

    static _disposeBrowserSetAndTestedApp(browserSet, testedApp) {
        return (0, _asyncToGenerator3.default)(function* () {
            yield browserSet.dispose();

            if (testedApp) yield testedApp.kill();
        })();
    }

    _createCancelablePromise(taskPromise) {
        const promise = taskPromise.then(({ completionPromise }) => completionPromise);
        const removeFromPending = () => (0, _lodash.pull)(this.pendingTaskPromises, promise);

        promise.then(removeFromPending).catch(removeFromPending);

        promise.cancel = () => taskPromise.then(({ cancelTask }) => cancelTask()).then(removeFromPending);

        this.pendingTaskPromises.push(promise);
        return promise;
    }

    // Run task
    _getFailedTestCount(task, reporter) {
        let failedTestCount = reporter.testCount - reporter.passed;

        if (task.opts.stopOnFirstFail && !!failedTestCount) failedTestCount = 1;

        return failedTestCount;
    }

    _getTaskResult(task, browserSet, reporter, testedApp) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            task.on('browser-job-done', function (job) {
                return browserSet.releaseConnection(job.browserConnection);
            });

            const promises = [(0, _promisifyEvent2.default)(task, 'done'), (0, _promisifyEvent2.default)(browserSet, 'error')];

            if (testedApp) promises.push(testedApp.errorPromise);

            try {
                yield _pinkie2.default.race(promises);
            } catch (err) {
                yield Runner._disposeTaskAndRelatedAssets(task, browserSet, testedApp);

                throw err;
            }

            yield Runner._disposeBrowserSetAndTestedApp(browserSet, testedApp);

            return _this._getFailedTestCount(task, reporter);
        })();
    }

    _runTask(reporterPlugins, browserSet, tests, testedApp) {
        let completed = false;
        const task = new _task2.default(tests, browserSet.browserConnectionGroups, this.proxy, this.opts);
        const reporters = reporterPlugins.map(reporter => new _reporter2.default(reporter.plugin, task, reporter.outStream));
        const completionPromise = this._getTaskResult(task, browserSet, reporters[0], testedApp);

        task.once('start', _handleErrors.startHandlingTestErrors);

        if (!this.opts.skipUncaughtErrors) {
            task.on('test-run-start', _handleErrors.addRunningTest);
            task.on('test-run-done', _handleErrors.removeRunningTest);
        }

        task.once('done', _handleErrors.stopHandlingTestErrors);

        const setCompleted = () => {
            completed = true;
        };

        completionPromise.then(setCompleted).catch(setCompleted);

        const cancelTask = (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* () {
                if (!completed) yield Runner._disposeTaskAndRelatedAssets(task, browserSet, testedApp);
            });

            return function cancelTask() {
                return _ref.apply(this, arguments);
            };
        })();

        return { completionPromise, cancelTask };
    }

    _registerAssets(assets) {
        assets.forEach(asset => this.proxy.GET(asset.path, asset.info));
    }

    _validateRunOptions() {
        const concurrency = this.bootstrapper.concurrency;
        const speed = this.opts.speed;
        const screenshotPath = this.opts.screenshotPath;
        const screenshotPathPattern = this.opts.screenshotPathPattern;
        let proxyBypass = this.opts.proxyBypass;

        if (screenshotPath) {
            this._validateScreenshotPath(screenshotPath, 'screenshots base directory path');

            this.opts.screenshotPath = (0, _path.resolve)(screenshotPath);
        }

        if (screenshotPathPattern) this._validateScreenshotPath(screenshotPathPattern, 'screenshots path pattern');

        if (typeof speed !== 'number' || isNaN(speed) || speed < 0.01 || speed > 1) throw new _runtime.GeneralError(_message2.default.invalidSpeedValue);

        if (typeof concurrency !== 'number' || isNaN(concurrency) || concurrency < 1) throw new _runtime.GeneralError(_message2.default.invalidConcurrencyFactor);

        if (proxyBypass) {
            (0, _typeAssertions.assertType)([_typeAssertions.is.string, _typeAssertions.is.array], null, '"proxyBypass" argument', proxyBypass);

            if (typeof proxyBypass === 'string') proxyBypass = [proxyBypass];

            proxyBypass = proxyBypass.reduce((arr, rules) => {
                (0, _typeAssertions.assertType)(_typeAssertions.is.string, null, '"proxyBypass" argument', rules);

                return arr.concat(rules.split(','));
            }, []);

            this.opts.proxyBypass = proxyBypass;
        }
    }

    _validateScreenshotPath(screenshotPath, pathType) {
        const forbiddenCharsList = (0, _checkFilePath2.default)(screenshotPath);

        if (forbiddenCharsList.length) throw new _runtime.GeneralError(_message2.default.forbiddenCharatersInScreenshotPath, screenshotPath, pathType, (0, _renderForbiddenCharsList2.default)(forbiddenCharsList));
    }

    // API
    embeddingOptions(opts) {
        this._registerAssets(opts.assets);
        this.opts.TestRunCtor = opts.TestRunCtor;

        return this;
    }

    src(...sources) {
        this.bootstrapper.sources = this.bootstrapper.sources.concat((0, _lodash.flattenDeep)(sources));

        return this;
    }

    browsers(...browsers) {
        this.bootstrapper.browsers = this.bootstrapper.browsers.concat((0, _lodash.flattenDeep)(browsers));

        return this;
    }

    concurrency(concurrency) {
        this.bootstrapper.concurrency = concurrency;

        return this;
    }

    reporter(name, outStream) {
        this.bootstrapper.reporters.push({
            name,
            outStream
        });

        return this;
    }

    filter(filter) {
        this.bootstrapper.filter = filter;

        return this;
    }

    useProxy(externalProxyHost, proxyBypass) {
        this.opts.externalProxyHost = externalProxyHost;
        this.opts.proxyBypass = proxyBypass;

        return this;
    }

    screenshots(path, takeOnFails = false, pattern = null) {
        this.opts.takeScreenshotsOnFails = takeOnFails;
        this.opts.screenshotPath = path;
        this.opts.screenshotPathPattern = pattern;

        return this;
    }

    startApp(command, initDelay) {
        this.bootstrapper.appCommand = command;
        this.bootstrapper.appInitDelay = initDelay;

        return this;
    }

    run({ skipJsErrors, disablePageReloads, quarantineMode, debugMode, selectorTimeout, assertionTimeout, pageLoadTimeout, speed = 1, debugOnFail, skipUncaughtErrors, stopOnFirstFail, disableTestSyntaxValidation } = {}) {
        this.opts.skipJsErrors = !!skipJsErrors;
        this.opts.disablePageReloads = !!disablePageReloads;
        this.opts.quarantineMode = !!quarantineMode;
        this.opts.debugMode = !!debugMode;
        this.opts.debugOnFail = !!debugOnFail;
        this.opts.selectorTimeout = selectorTimeout === void 0 ? DEFAULT_SELECTOR_TIMEOUT : selectorTimeout;
        this.opts.assertionTimeout = assertionTimeout === void 0 ? DEFAULT_ASSERTION_TIMEOUT : assertionTimeout;
        this.opts.pageLoadTimeout = pageLoadTimeout === void 0 ? DEFAULT_PAGE_LOAD_TIMEOUT : pageLoadTimeout;
        this.opts.speed = speed;
        this.opts.skipUncaughtErrors = !!skipUncaughtErrors;
        this.opts.stopOnFirstFail = !!stopOnFirstFail;

        this.bootstrapper.disableTestSyntaxValidation = disableTestSyntaxValidation;

        const runTaskPromise = _pinkie2.default.resolve().then(() => {
            this._validateRunOptions();

            return this.bootstrapper.createRunnableConfiguration();
        }).then(({ reporterPlugins, browserSet, tests, testedApp }) => {
            this.emit('done-bootstrapping');

            return this._runTask(reporterPlugins, browserSet, tests, testedApp);
        });

        return this._createCancelablePromise(runTaskPromise);
    }

    stop() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            // NOTE: When taskPromise is cancelled, it is removed from
            // the pendingTaskPromises array, which leads to shifting indexes
            // towards the beginning. So, we must copy the array in order to iterate it,
            // or we can perform iteration from the end to the beginning.
            const cancellationPromises = (0, _mapReverse2.default)(_this2.pendingTaskPromises, function (taskPromise) {
                return taskPromise.cancel();
            });

            yield _pinkie2.default.all(cancellationPromises);
        })();
    }
}
exports.default = Runner;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW5uZXIvaW5kZXguanMiXSwibmFtZXMiOlsiREVGQVVMVF9TRUxFQ1RPUl9USU1FT1VUIiwiREVGQVVMVF9BU1NFUlRJT05fVElNRU9VVCIsIkRFRkFVTFRfUEFHRV9MT0FEX1RJTUVPVVQiLCJSdW5uZXIiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsInByb3h5IiwiYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5Iiwib3B0aW9ucyIsImJvb3RzdHJhcHBlciIsIkJvb3RzdHJhcHBlciIsInBlbmRpbmdUYXNrUHJvbWlzZXMiLCJvcHRzIiwiZXh0ZXJuYWxQcm94eUhvc3QiLCJwcm94eUJ5cGFzcyIsInNjcmVlbnNob3RQYXRoIiwidGFrZVNjcmVlbnNob3RzT25GYWlscyIsInNjcmVlbnNob3RQYXRoUGF0dGVybiIsInNraXBKc0Vycm9ycyIsInF1YXJhbnRpbmVNb2RlIiwiZGVidWdNb2RlIiwicmV0cnlUZXN0UGFnZXMiLCJzZWxlY3RvclRpbWVvdXQiLCJwYWdlTG9hZFRpbWVvdXQiLCJfZGlzcG9zZVRhc2tBbmRSZWxhdGVkQXNzZXRzIiwidGFzayIsImJyb3dzZXJTZXQiLCJ0ZXN0ZWRBcHAiLCJhYm9ydCIsInJlbW92ZUFsbExpc3RlbmVycyIsIl9kaXNwb3NlQnJvd3NlclNldEFuZFRlc3RlZEFwcCIsImRpc3Bvc2UiLCJraWxsIiwiX2NyZWF0ZUNhbmNlbGFibGVQcm9taXNlIiwidGFza1Byb21pc2UiLCJwcm9taXNlIiwidGhlbiIsImNvbXBsZXRpb25Qcm9taXNlIiwicmVtb3ZlRnJvbVBlbmRpbmciLCJjYXRjaCIsImNhbmNlbCIsImNhbmNlbFRhc2siLCJwdXNoIiwiX2dldEZhaWxlZFRlc3RDb3VudCIsInJlcG9ydGVyIiwiZmFpbGVkVGVzdENvdW50IiwidGVzdENvdW50IiwicGFzc2VkIiwic3RvcE9uRmlyc3RGYWlsIiwiX2dldFRhc2tSZXN1bHQiLCJvbiIsInJlbGVhc2VDb25uZWN0aW9uIiwiam9iIiwiYnJvd3NlckNvbm5lY3Rpb24iLCJwcm9taXNlcyIsImVycm9yUHJvbWlzZSIsIlByb21pc2UiLCJyYWNlIiwiZXJyIiwiX3J1blRhc2siLCJyZXBvcnRlclBsdWdpbnMiLCJ0ZXN0cyIsImNvbXBsZXRlZCIsIlRhc2siLCJicm93c2VyQ29ubmVjdGlvbkdyb3VwcyIsInJlcG9ydGVycyIsIm1hcCIsIlJlcG9ydGVyIiwicGx1Z2luIiwib3V0U3RyZWFtIiwib25jZSIsInN0YXJ0SGFuZGxpbmdUZXN0RXJyb3JzIiwic2tpcFVuY2F1Z2h0RXJyb3JzIiwiYWRkUnVubmluZ1Rlc3QiLCJyZW1vdmVSdW5uaW5nVGVzdCIsInN0b3BIYW5kbGluZ1Rlc3RFcnJvcnMiLCJzZXRDb21wbGV0ZWQiLCJfcmVnaXN0ZXJBc3NldHMiLCJhc3NldHMiLCJmb3JFYWNoIiwiYXNzZXQiLCJHRVQiLCJwYXRoIiwiaW5mbyIsIl92YWxpZGF0ZVJ1bk9wdGlvbnMiLCJjb25jdXJyZW5jeSIsInNwZWVkIiwiX3ZhbGlkYXRlU2NyZWVuc2hvdFBhdGgiLCJpc05hTiIsIkdlbmVyYWxFcnJvciIsIk1FU1NBR0UiLCJpbnZhbGlkU3BlZWRWYWx1ZSIsImludmFsaWRDb25jdXJyZW5jeUZhY3RvciIsImlzIiwic3RyaW5nIiwiYXJyYXkiLCJyZWR1Y2UiLCJhcnIiLCJydWxlcyIsImNvbmNhdCIsInNwbGl0IiwicGF0aFR5cGUiLCJmb3JiaWRkZW5DaGFyc0xpc3QiLCJsZW5ndGgiLCJmb3JiaWRkZW5DaGFyYXRlcnNJblNjcmVlbnNob3RQYXRoIiwiZW1iZWRkaW5nT3B0aW9ucyIsIlRlc3RSdW5DdG9yIiwic3JjIiwic291cmNlcyIsImJyb3dzZXJzIiwibmFtZSIsImZpbHRlciIsInVzZVByb3h5Iiwic2NyZWVuc2hvdHMiLCJ0YWtlT25GYWlscyIsInBhdHRlcm4iLCJzdGFydEFwcCIsImNvbW1hbmQiLCJpbml0RGVsYXkiLCJhcHBDb21tYW5kIiwiYXBwSW5pdERlbGF5IiwicnVuIiwiZGlzYWJsZVBhZ2VSZWxvYWRzIiwiYXNzZXJ0aW9uVGltZW91dCIsImRlYnVnT25GYWlsIiwiZGlzYWJsZVRlc3RTeW50YXhWYWxpZGF0aW9uIiwicnVuVGFza1Byb21pc2UiLCJyZXNvbHZlIiwiY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uIiwiZW1pdCIsInN0b3AiLCJjYW5jZWxsYXRpb25Qcm9taXNlcyIsImFsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBLE1BQU1BLDJCQUE0QixLQUFsQztBQUNBLE1BQU1DLDRCQUE0QixJQUFsQztBQUNBLE1BQU1DLDRCQUE0QixJQUFsQzs7QUFFZSxNQUFNQyxNQUFOLFNBQXFCQyxvQkFBckIsQ0FBa0M7QUFDN0NDLGdCQUFhQyxLQUFiLEVBQW9CQyx3QkFBcEIsRUFBOENDLFVBQVUsRUFBeEQsRUFBNEQ7QUFDeEQ7O0FBRUEsYUFBS0YsS0FBTCxHQUEyQkEsS0FBM0I7QUFDQSxhQUFLRyxZQUFMLEdBQTJCLElBQUlDLHNCQUFKLENBQWlCSCx3QkFBakIsQ0FBM0I7QUFDQSxhQUFLSSxtQkFBTCxHQUEyQixFQUEzQjs7QUFFQSxhQUFLQyxJQUFMLEdBQVk7QUFDUkMsK0JBQXdCLElBRGhCO0FBRVJDLHlCQUF3QixJQUZoQjtBQUdSQyw0QkFBd0IsSUFIaEI7QUFJUkMsb0NBQXdCLEtBSmhCO0FBS1JDLG1DQUF3QixJQUxoQjtBQU1SQywwQkFBd0IsS0FOaEI7QUFPUkMsNEJBQXdCLEtBUGhCO0FBUVJDLHVCQUF3QixLQVJoQjtBQVNSQyw0QkFBd0JiLFFBQVFhLGNBVHhCO0FBVVJDLDZCQUF3QnRCLHdCQVZoQjtBQVdSdUIsNkJBQXdCckI7QUFYaEIsU0FBWjtBQWFIOztBQUVELFdBQWFzQiw0QkFBYixDQUEyQ0MsSUFBM0MsRUFBaURDLFVBQWpELEVBQTZEQyxTQUE3RCxFQUF3RTtBQUFB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bUMsS0FBL0IsRUFBc0NsQyxTQUF0QyxFQUFELEtBQXVEO0FBQ3pELGlCQUFLc0csSUFBTCxDQUFVLG9CQUFWOztBQUVBLG1CQUFPLEtBQUt0RSxRQUFMLENBQWNDLGVBQWQsRUFBK0JsQyxVQUEvQixFQUEyQ21DLEtBQTNDLEVBQWtEbEMsU0FBbEQsQ0FBUDtBQUNILFNBVmtCLENBQXZCOztBQVlBLGVBQU8sS0FBS00sd0JBQUwsQ0FBOEI2RixjQUE5QixDQUFQO0FBQ0g7O0FBRUtJLFFBQU4sR0FBYztBQUFBOztBQUFBO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrQkFBTUMsdUJBQXVCLDBCQUFXLE9BQUt4SCxtQkFBaEIsRUFBcUM7QUFBQSx1QkFBZXVCLFlBQVlNLE1BQVosRUFBZjtBQUFBLGFBQXJDLENBQTdCOztBQUVBLGtCQUFNZ0IsaUJBQVE0RSxHQUFSLENBQVlELG9CQUFaLENBQU47QUFQVTtBQVFiO0FBN1E0QztrQkFBNUJoSSxNIiwiZmlsZSI6InJ1bm5lci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJlc29sdmUgYXMgcmVzb2x2ZVBhdGggfSBmcm9tICdwYXRoJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgcHJvbWlzaWZ5RXZlbnQgZnJvbSAncHJvbWlzaWZ5LWV2ZW50JztcbmltcG9ydCBtYXBSZXZlcnNlIGZyb20gJ21hcC1yZXZlcnNlJztcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBmbGF0dGVuRGVlcCBhcyBmbGF0dGVuLCBwdWxsIGFzIHJlbW92ZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQm9vdHN0cmFwcGVyIGZyb20gJy4vYm9vdHN0cmFwcGVyJztcbmltcG9ydCBSZXBvcnRlciBmcm9tICcuLi9yZXBvcnRlcic7XG5pbXBvcnQgVGFzayBmcm9tICcuL3Rhc2snO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IE1FU1NBR0UgZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUvbWVzc2FnZSc7XG5pbXBvcnQgeyBhc3NlcnRUeXBlLCBpcyB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lL3R5cGUtYXNzZXJ0aW9ucyc7XG5pbXBvcnQgcmVuZGVyRm9yYmlkZGVuQ2hhcnNMaXN0IGZyb20gJy4uL2Vycm9ycy9yZW5kZXItZm9yYmlkZGVuLWNoYXJzLWxpc3QnO1xuaW1wb3J0IGNoZWNrRmlsZVBhdGggZnJvbSAnLi4vdXRpbHMvY2hlY2stZmlsZS1wYXRoJztcbmltcG9ydCB7IGFkZFJ1bm5pbmdUZXN0LCByZW1vdmVSdW5uaW5nVGVzdCwgc3RhcnRIYW5kbGluZ1Rlc3RFcnJvcnMsIHN0b3BIYW5kbGluZ1Rlc3RFcnJvcnMgfSBmcm9tICcuLi91dGlscy9oYW5kbGUtZXJyb3JzJztcblxuY29uc3QgREVGQVVMVF9TRUxFQ1RPUl9USU1FT1VUICA9IDEwMDAwO1xuY29uc3QgREVGQVVMVF9BU1NFUlRJT05fVElNRU9VVCA9IDMwMDA7XG5jb25zdCBERUZBVUxUX1BBR0VfTE9BRF9USU1FT1VUID0gMzAwMDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUnVubmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAocHJveHksIGJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSwgb3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5wcm94eSAgICAgICAgICAgICAgID0gcHJveHk7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyICAgICAgICA9IG5ldyBCb290c3RyYXBwZXIoYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5KTtcbiAgICAgICAgdGhpcy5wZW5kaW5nVGFza1Byb21pc2VzID0gW107XG5cbiAgICAgICAgdGhpcy5vcHRzID0ge1xuICAgICAgICAgICAgZXh0ZXJuYWxQcm94eUhvc3Q6ICAgICAgbnVsbCxcbiAgICAgICAgICAgIHByb3h5QnlwYXNzOiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aDogICAgICAgICBudWxsLFxuICAgICAgICAgICAgdGFrZVNjcmVlbnNob3RzT25GYWlsczogZmFsc2UsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aFBhdHRlcm46ICBudWxsLFxuICAgICAgICAgICAgc2tpcEpzRXJyb3JzOiAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICBxdWFyYW50aW5lTW9kZTogICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGRlYnVnTW9kZTogICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgcmV0cnlUZXN0UGFnZXM6ICAgICAgICAgb3B0aW9ucy5yZXRyeVRlc3RQYWdlcyxcbiAgICAgICAgICAgIHNlbGVjdG9yVGltZW91dDogICAgICAgIERFRkFVTFRfU0VMRUNUT1JfVElNRU9VVCxcbiAgICAgICAgICAgIHBhZ2VMb2FkVGltZW91dDogICAgICAgIERFRkFVTFRfUEFHRV9MT0FEX1RJTUVPVVRcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgX2Rpc3Bvc2VUYXNrQW5kUmVsYXRlZEFzc2V0cyAodGFzaywgYnJvd3NlclNldCwgdGVzdGVkQXBwKSB7XG4gICAgICAgIHRhc2suYWJvcnQoKTtcbiAgICAgICAgdGFzay5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcblxuICAgICAgICBhd2FpdCBSdW5uZXIuX2Rpc3Bvc2VCcm93c2VyU2V0QW5kVGVzdGVkQXBwKGJyb3dzZXJTZXQsIHRlc3RlZEFwcCk7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIF9kaXNwb3NlQnJvd3NlclNldEFuZFRlc3RlZEFwcCAoYnJvd3NlclNldCwgdGVzdGVkQXBwKSB7XG4gICAgICAgIGF3YWl0IGJyb3dzZXJTZXQuZGlzcG9zZSgpO1xuXG4gICAgICAgIGlmICh0ZXN0ZWRBcHApXG4gICAgICAgICAgICBhd2FpdCB0ZXN0ZWRBcHAua2lsbCgpO1xuICAgIH1cblxuICAgIF9jcmVhdGVDYW5jZWxhYmxlUHJvbWlzZSAodGFza1Byb21pc2UpIHtcbiAgICAgICAgY29uc3QgcHJvbWlzZSAgICAgICAgICAgPSB0YXNrUHJvbWlzZS50aGVuKCh7IGNvbXBsZXRpb25Qcm9taXNlIH0pID0+IGNvbXBsZXRpb25Qcm9taXNlKTtcbiAgICAgICAgY29uc3QgcmVtb3ZlRnJvbVBlbmRpbmcgPSAoKSA9PiByZW1vdmUodGhpcy5wZW5kaW5nVGFza1Byb21pc2VzLCBwcm9taXNlKTtcblxuICAgICAgICBwcm9taXNlXG4gICAgICAgICAgICAudGhlbihyZW1vdmVGcm9tUGVuZGluZylcbiAgICAgICAgICAgIC5jYXRjaChyZW1vdmVGcm9tUGVuZGluZyk7XG5cbiAgICAgICAgcHJvbWlzZS5jYW5jZWwgPSAoKSA9PiB0YXNrUHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oKHsgY2FuY2VsVGFzayB9KSA9PiBjYW5jZWxUYXNrKCkpXG4gICAgICAgICAgICAudGhlbihyZW1vdmVGcm9tUGVuZGluZyk7XG5cbiAgICAgICAgdGhpcy5wZW5kaW5nVGFza1Byb21pc2VzLnB1c2gocHJvbWlzZSk7XG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgIH1cblxuICAgIC8vIFJ1biB0YXNrXG4gICAgX2dldEZhaWxlZFRlc3RDb3VudCAodGFzaywgcmVwb3J0ZXIpIHtcbiAgICAgICAgbGV0IGZhaWxlZFRlc3RDb3VudCA9IHJlcG9ydGVyLnRlc3RDb3VudCAtIHJlcG9ydGVyLnBhc3NlZDtcblxuICAgICAgICBpZiAodGFzay5vcHRzLnN0b3BPbkZpcnN0RmFpbCAmJiAhIWZhaWxlZFRlc3RDb3VudClcbiAgICAgICAgICAgIGZhaWxlZFRlc3RDb3VudCA9IDE7XG5cbiAgICAgICAgcmV0dXJuIGZhaWxlZFRlc3RDb3VudDtcbiAgICB9XG5cbiAgICBhc3luYyBfZ2V0VGFza1Jlc3VsdCAodGFzaywgYnJvd3NlclNldCwgcmVwb3J0ZXIsIHRlc3RlZEFwcCkge1xuICAgICAgICB0YXNrLm9uKCdicm93c2VyLWpvYi1kb25lJywgam9iID0+IGJyb3dzZXJTZXQucmVsZWFzZUNvbm5lY3Rpb24oam9iLmJyb3dzZXJDb25uZWN0aW9uKSk7XG5cbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXG4gICAgICAgICAgICBwcm9taXNpZnlFdmVudCh0YXNrLCAnZG9uZScpLFxuICAgICAgICAgICAgcHJvbWlzaWZ5RXZlbnQoYnJvd3NlclNldCwgJ2Vycm9yJylcbiAgICAgICAgXTtcblxuICAgICAgICBpZiAodGVzdGVkQXBwKVxuICAgICAgICAgICAgcHJvbWlzZXMucHVzaCh0ZXN0ZWRBcHAuZXJyb3JQcm9taXNlKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5yYWNlKHByb21pc2VzKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBhd2FpdCBSdW5uZXIuX2Rpc3Bvc2VUYXNrQW5kUmVsYXRlZEFzc2V0cyh0YXNrLCBicm93c2VyU2V0LCB0ZXN0ZWRBcHApO1xuXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBSdW5uZXIuX2Rpc3Bvc2VCcm93c2VyU2V0QW5kVGVzdGVkQXBwKGJyb3dzZXJTZXQsIHRlc3RlZEFwcCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldEZhaWxlZFRlc3RDb3VudCh0YXNrLCByZXBvcnRlcik7XG4gICAgfVxuXG4gICAgX3J1blRhc2sgKHJlcG9ydGVyUGx1Z2lucywgYnJvd3NlclNldCwgdGVzdHMsIHRlc3RlZEFwcCkge1xuICAgICAgICBsZXQgY29tcGxldGVkICAgICAgICAgICA9IGZhbHNlO1xuICAgICAgICBjb25zdCB0YXNrICAgICAgICAgICAgICA9IG5ldyBUYXNrKHRlc3RzLCBicm93c2VyU2V0LmJyb3dzZXJDb25uZWN0aW9uR3JvdXBzLCB0aGlzLnByb3h5LCB0aGlzLm9wdHMpO1xuICAgICAgICBjb25zdCByZXBvcnRlcnMgICAgICAgICA9IHJlcG9ydGVyUGx1Z2lucy5tYXAocmVwb3J0ZXIgPT4gbmV3IFJlcG9ydGVyKHJlcG9ydGVyLnBsdWdpbiwgdGFzaywgcmVwb3J0ZXIub3V0U3RyZWFtKSk7XG4gICAgICAgIGNvbnN0IGNvbXBsZXRpb25Qcm9taXNlID0gdGhpcy5fZ2V0VGFza1Jlc3VsdCh0YXNrLCBicm93c2VyU2V0LCByZXBvcnRlcnNbMF0sIHRlc3RlZEFwcCk7XG5cbiAgICAgICAgdGFzay5vbmNlKCdzdGFydCcsIHN0YXJ0SGFuZGxpbmdUZXN0RXJyb3JzKTtcblxuICAgICAgICBpZiAoIXRoaXMub3B0cy5za2lwVW5jYXVnaHRFcnJvcnMpIHtcbiAgICAgICAgICAgIHRhc2sub24oJ3Rlc3QtcnVuLXN0YXJ0JywgYWRkUnVubmluZ1Rlc3QpO1xuICAgICAgICAgICAgdGFzay5vbigndGVzdC1ydW4tZG9uZScsIHJlbW92ZVJ1bm5pbmdUZXN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRhc2sub25jZSgnZG9uZScsIHN0b3BIYW5kbGluZ1Rlc3RFcnJvcnMpO1xuXG4gICAgICAgIGNvbnN0IHNldENvbXBsZXRlZCA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbXBsZXRlZCA9IHRydWU7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29tcGxldGlvblByb21pc2VcbiAgICAgICAgICAgIC50aGVuKHNldENvbXBsZXRlZClcbiAgICAgICAgICAgIC5jYXRjaChzZXRDb21wbGV0ZWQpO1xuXG4gICAgICAgIGNvbnN0IGNhbmNlbFRhc2sgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWNvbXBsZXRlZClcbiAgICAgICAgICAgICAgICBhd2FpdCBSdW5uZXIuX2Rpc3Bvc2VUYXNrQW5kUmVsYXRlZEFzc2V0cyh0YXNrLCBicm93c2VyU2V0LCB0ZXN0ZWRBcHApO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB7IGNvbXBsZXRpb25Qcm9taXNlLCBjYW5jZWxUYXNrIH07XG4gICAgfVxuXG4gICAgX3JlZ2lzdGVyQXNzZXRzIChhc3NldHMpIHtcbiAgICAgICAgYXNzZXRzLmZvckVhY2goYXNzZXQgPT4gdGhpcy5wcm94eS5HRVQoYXNzZXQucGF0aCwgYXNzZXQuaW5mbykpO1xuICAgIH1cblxuICAgIF92YWxpZGF0ZVJ1bk9wdGlvbnMgKCkge1xuICAgICAgICBjb25zdCBjb25jdXJyZW5jeSAgICAgICAgICAgPSB0aGlzLmJvb3RzdHJhcHBlci5jb25jdXJyZW5jeTtcbiAgICAgICAgY29uc3Qgc3BlZWQgICAgICAgICAgICAgICAgID0gdGhpcy5vcHRzLnNwZWVkO1xuICAgICAgICBjb25zdCBzY3JlZW5zaG90UGF0aCAgICAgICAgPSB0aGlzLm9wdHMuc2NyZWVuc2hvdFBhdGg7XG4gICAgICAgIGNvbnN0IHNjcmVlbnNob3RQYXRoUGF0dGVybiA9IHRoaXMub3B0cy5zY3JlZW5zaG90UGF0aFBhdHRlcm47XG4gICAgICAgIGxldCBwcm94eUJ5cGFzcyAgICAgICAgICAgICA9IHRoaXMub3B0cy5wcm94eUJ5cGFzcztcblxuICAgICAgICBpZiAoc2NyZWVuc2hvdFBhdGgpIHtcbiAgICAgICAgICAgIHRoaXMuX3ZhbGlkYXRlU2NyZWVuc2hvdFBhdGgoc2NyZWVuc2hvdFBhdGgsICdzY3JlZW5zaG90cyBiYXNlIGRpcmVjdG9yeSBwYXRoJyk7XG5cbiAgICAgICAgICAgIHRoaXMub3B0cy5zY3JlZW5zaG90UGF0aCA9IHJlc29sdmVQYXRoKHNjcmVlbnNob3RQYXRoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzY3JlZW5zaG90UGF0aFBhdHRlcm4pXG4gICAgICAgICAgICB0aGlzLl92YWxpZGF0ZVNjcmVlbnNob3RQYXRoKHNjcmVlbnNob3RQYXRoUGF0dGVybiwgJ3NjcmVlbnNob3RzIHBhdGggcGF0dGVybicpO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgIT09ICdudW1iZXInIHx8IGlzTmFOKHNwZWVkKSB8fCBzcGVlZCA8IDAuMDEgfHwgc3BlZWQgPiAxKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmludmFsaWRTcGVlZFZhbHVlKTtcblxuICAgICAgICBpZiAodHlwZW9mIGNvbmN1cnJlbmN5ICE9PSAnbnVtYmVyJyB8fCBpc05hTihjb25jdXJyZW5jeSkgfHwgY29uY3VycmVuY3kgPCAxKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmludmFsaWRDb25jdXJyZW5jeUZhY3Rvcik7XG5cbiAgICAgICAgaWYgKHByb3h5QnlwYXNzKSB7XG4gICAgICAgICAgICBhc3NlcnRUeXBlKFsgaXMuc3RyaW5nLCBpcy5hcnJheSBdLCBudWxsLCAnXCJwcm94eUJ5cGFzc1wiIGFyZ3VtZW50JywgcHJveHlCeXBhc3MpO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHByb3h5QnlwYXNzID09PSAnc3RyaW5nJylcbiAgICAgICAgICAgICAgICBwcm94eUJ5cGFzcyA9IFtwcm94eUJ5cGFzc107XG5cbiAgICAgICAgICAgIHByb3h5QnlwYXNzID0gcHJveHlCeXBhc3MucmVkdWNlKChhcnIsIHJ1bGVzKSA9PiB7XG4gICAgICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5zdHJpbmcsIG51bGwsICdcInByb3h5QnlwYXNzXCIgYXJndW1lbnQnLCBydWxlcyk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYXJyLmNvbmNhdChydWxlcy5zcGxpdCgnLCcpKTtcbiAgICAgICAgICAgIH0sIFtdKTtcblxuICAgICAgICAgICAgdGhpcy5vcHRzLnByb3h5QnlwYXNzID0gcHJveHlCeXBhc3M7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfdmFsaWRhdGVTY3JlZW5zaG90UGF0aCAoc2NyZWVuc2hvdFBhdGgsIHBhdGhUeXBlKSB7XG4gICAgICAgIGNvbnN0IGZvcmJpZGRlbkNoYXJzTGlzdCA9IGNoZWNrRmlsZVBhdGgoc2NyZWVuc2hvdFBhdGgpO1xuXG4gICAgICAgIGlmIChmb3JiaWRkZW5DaGFyc0xpc3QubGVuZ3RoKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmZvcmJpZGRlbkNoYXJhdGVyc0luU2NyZWVuc2hvdFBhdGgsIHNjcmVlbnNob3RQYXRoLCBwYXRoVHlwZSwgcmVuZGVyRm9yYmlkZGVuQ2hhcnNMaXN0KGZvcmJpZGRlbkNoYXJzTGlzdCkpO1xuICAgIH1cblxuICAgIC8vIEFQSVxuICAgIGVtYmVkZGluZ09wdGlvbnMgKG9wdHMpIHtcbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJBc3NldHMob3B0cy5hc3NldHMpO1xuICAgICAgICB0aGlzLm9wdHMuVGVzdFJ1bkN0b3IgPSBvcHRzLlRlc3RSdW5DdG9yO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHNyYyAoLi4uc291cmNlcykge1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5zb3VyY2VzID0gdGhpcy5ib290c3RyYXBwZXIuc291cmNlcy5jb25jYXQoZmxhdHRlbihzb3VyY2VzKSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYnJvd3NlcnMgKC4uLmJyb3dzZXJzKSB7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmJyb3dzZXJzID0gdGhpcy5ib290c3RyYXBwZXIuYnJvd3NlcnMuY29uY2F0KGZsYXR0ZW4oYnJvd3NlcnMpKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBjb25jdXJyZW5jeSAoY29uY3VycmVuY3kpIHtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuY29uY3VycmVuY3kgPSBjb25jdXJyZW5jeTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICByZXBvcnRlciAobmFtZSwgb3V0U3RyZWFtKSB7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLnJlcG9ydGVycy5wdXNoKHtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICBvdXRTdHJlYW1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZmlsdGVyIChmaWx0ZXIpIHtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuZmlsdGVyID0gZmlsdGVyO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHVzZVByb3h5IChleHRlcm5hbFByb3h5SG9zdCwgcHJveHlCeXBhc3MpIHtcbiAgICAgICAgdGhpcy5vcHRzLmV4dGVybmFsUHJveHlIb3N0ID0gZXh0ZXJuYWxQcm94eUhvc3Q7XG4gICAgICAgIHRoaXMub3B0cy5wcm94eUJ5cGFzcyAgICAgICA9IHByb3h5QnlwYXNzO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHNjcmVlbnNob3RzIChwYXRoLCB0YWtlT25GYWlscyA9IGZhbHNlLCBwYXR0ZXJuID0gbnVsbCkge1xuICAgICAgICB0aGlzLm9wdHMudGFrZVNjcmVlbnNob3RzT25GYWlscyA9IHRha2VPbkZhaWxzO1xuICAgICAgICB0aGlzLm9wdHMuc2NyZWVuc2hvdFBhdGggICAgICAgICA9IHBhdGg7XG4gICAgICAgIHRoaXMub3B0cy5zY3JlZW5zaG90UGF0aFBhdHRlcm4gID0gcGF0dGVybjtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBzdGFydEFwcCAoY29tbWFuZCwgaW5pdERlbGF5KSB7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmFwcENvbW1hbmQgICA9IGNvbW1hbmQ7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmFwcEluaXREZWxheSA9IGluaXREZWxheTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBydW4gKHsgc2tpcEpzRXJyb3JzLCBkaXNhYmxlUGFnZVJlbG9hZHMsIHF1YXJhbnRpbmVNb2RlLCBkZWJ1Z01vZGUsIHNlbGVjdG9yVGltZW91dCwgYXNzZXJ0aW9uVGltZW91dCwgcGFnZUxvYWRUaW1lb3V0LCBzcGVlZCA9IDEsIGRlYnVnT25GYWlsLCBza2lwVW5jYXVnaHRFcnJvcnMsIHN0b3BPbkZpcnN0RmFpbCwgZGlzYWJsZVRlc3RTeW50YXhWYWxpZGF0aW9uIH0gPSB7fSkge1xuICAgICAgICB0aGlzLm9wdHMuc2tpcEpzRXJyb3JzICAgICAgID0gISFza2lwSnNFcnJvcnM7XG4gICAgICAgIHRoaXMub3B0cy5kaXNhYmxlUGFnZVJlbG9hZHMgPSAhIWRpc2FibGVQYWdlUmVsb2FkcztcbiAgICAgICAgdGhpcy5vcHRzLnF1YXJhbnRpbmVNb2RlICAgICA9ICEhcXVhcmFudGluZU1vZGU7XG4gICAgICAgIHRoaXMub3B0cy5kZWJ1Z01vZGUgICAgICAgICAgPSAhIWRlYnVnTW9kZTtcbiAgICAgICAgdGhpcy5vcHRzLmRlYnVnT25GYWlsICAgICAgICA9ICEhZGVidWdPbkZhaWw7XG4gICAgICAgIHRoaXMub3B0cy5zZWxlY3RvclRpbWVvdXQgICAgPSBzZWxlY3RvclRpbWVvdXQgPT09IHZvaWQgMCA/IERFRkFVTFRfU0VMRUNUT1JfVElNRU9VVCA6IHNlbGVjdG9yVGltZW91dDtcbiAgICAgICAgdGhpcy5vcHRzLmFzc2VydGlvblRpbWVvdXQgICA9IGFzc2VydGlvblRpbWVvdXQgPT09IHZvaWQgMCA/IERFRkFVTFRfQVNTRVJUSU9OX1RJTUVPVVQgOiBhc3NlcnRpb25UaW1lb3V0O1xuICAgICAgICB0aGlzLm9wdHMucGFnZUxvYWRUaW1lb3V0ICAgID0gcGFnZUxvYWRUaW1lb3V0ID09PSB2b2lkIDAgPyBERUZBVUxUX1BBR0VfTE9BRF9USU1FT1VUIDogcGFnZUxvYWRUaW1lb3V0O1xuICAgICAgICB0aGlzLm9wdHMuc3BlZWQgICAgICAgICAgICAgID0gc3BlZWQ7XG4gICAgICAgIHRoaXMub3B0cy5za2lwVW5jYXVnaHRFcnJvcnMgPSAhIXNraXBVbmNhdWdodEVycm9ycztcbiAgICAgICAgdGhpcy5vcHRzLnN0b3BPbkZpcnN0RmFpbCAgICA9ICEhc3RvcE9uRmlyc3RGYWlsO1xuXG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmRpc2FibGVUZXN0U3ludGF4VmFsaWRhdGlvbiA9IGRpc2FibGVUZXN0U3ludGF4VmFsaWRhdGlvbjtcblxuICAgICAgICBjb25zdCBydW5UYXNrUHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fdmFsaWRhdGVSdW5PcHRpb25zKCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ib290c3RyYXBwZXIuY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uKCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKHsgcmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwIH0pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2RvbmUtYm9vdHN0cmFwcGluZycpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3J1blRhc2socmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVDYW5jZWxhYmxlUHJvbWlzZShydW5UYXNrUHJvbWlzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcCAoKSB7XG4gICAgICAgIC8vIE5PVEU6IFdoZW4gdGFza1Byb21pc2UgaXMgY2FuY2VsbGVkLCBpdCBpcyByZW1vdmVkIGZyb21cbiAgICAgICAgLy8gdGhlIHBlbmRpbmdUYXNrUHJvbWlzZXMgYXJyYXksIHdoaWNoIGxlYWRzIHRvIHNoaWZ0aW5nIGluZGV4ZXNcbiAgICAgICAgLy8gdG93YXJkcyB0aGUgYmVnaW5uaW5nLiBTbywgd2UgbXVzdCBjb3B5IHRoZSBhcnJheSBpbiBvcmRlciB0byBpdGVyYXRlIGl0LFxuICAgICAgICAvLyBvciB3ZSBjYW4gcGVyZm9ybSBpdGVyYXRpb24gZnJvbSB0aGUgZW5kIHRvIHRoZSBiZWdpbm5pbmcuXG4gICAgICAgIGNvbnN0IGNhbmNlbGxhdGlvblByb21pc2VzID0gbWFwUmV2ZXJzZSh0aGlzLnBlbmRpbmdUYXNrUHJvbWlzZXMsIHRhc2tQcm9taXNlID0+IHRhc2tQcm9taXNlLmNhbmNlbCgpKTtcblxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChjYW5jZWxsYXRpb25Qcm9taXNlcyk7XG4gICAgfVxufVxuIl19
